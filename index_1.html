<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="theme-color" content="#06080f">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Vault LK">
<meta name="application-name" content="Vault LK">
<meta name="description" content="Smart personal finance tracker for Sri Lanka">
<meta name="mobile-web-app-capable" content="yes">
<link rel="manifest" id="pwa-manifest">
<link rel="apple-touch-icon" id="apple-icon">
<title>Vault LK</title>
<link href="https://fonts.googleapis.com/css2?family=Clash+Display:wght@400;500;600;700&family=Satoshi:wght@400;500;700;900&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#06080f;--s1:#0b0f1c;--s2:#111827;--s3:#1a2235;
  --ln:#1e2d4a;--ln2:#263550;
  --tx:#eef2ff;--tx2:#8fa3c8;--tx3:#3d5070;
  --gd:#f0c040;--gd2:#d4a200;--gdx:rgba(240,192,64,.12);
  --gr:#1fd47a;--grx:rgba(31,212,122,.1);
  --rd:#ff4466;--rdx:rgba(255,68,102,.1);
  --bl:#4d9fff;--blx:rgba(77,159,255,.1);
  --pu:#9d7afa;--pux:rgba(157,122,250,.1);
  --tl:#00d4c8;--tlx:rgba(0,212,200,.1);
  --or:#ff8c42;--orx:rgba(255,140,66,.1);
  --r:14px;--r2:10px;--r3:22px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{background:var(--bg);color:var(--tx);font-family:'Satoshi',sans-serif;min-height:100vh;overflow-x:hidden;overscroll-behavior:none}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 800px 600px at 50% -100px,rgba(77,159,255,.06),transparent);pointer-events:none;z-index:0}

/* â”€â”€ SCROLLBAR â”€â”€ */
::-webkit-scrollbar{width:2px;height:2px}
::-webkit-scrollbar-thumb{background:var(--ln2);border-radius:2px}

/* â”€â”€ UTIL â”€â”€ */
.shell{position:relative;z-index:1;max-width:640px;margin:0 auto;padding:0 16px 100px}
.hidden{display:none!important}
@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.04)}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.anim-fade-up{animation:fadeUp .4s cubic-bezier(.22,.68,0,1) both}
.spin{animation:spin .8s linear infinite}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ONBOARDING SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#onboarding{
  position:fixed;inset:0;z-index:1000;
  background:var(--bg);
  display:flex;flex-direction:column;align-items:center;justify-content:flex-start;
  padding:24px 24px calc(24px + env(safe-area-inset-bottom));
  padding-top:max(24px, env(safe-area-inset-top));
  animation:fadeIn .5s ease;
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
}
.ob-logo{
  font-family:'Clash Display',sans-serif;font-size:44px;font-weight:700;
  color:var(--gd);letter-spacing:-2px;margin-bottom:4px;
  text-shadow:0 0 40px rgba(240,192,64,.3);
}
.ob-tagline{font-family:'JetBrains Mono',monospace;font-size:11px;letter-spacing:3px;text-transform:uppercase;color:var(--tx3);margin-bottom:40px}
.ob-steps{width:100%;max-width:420px}
.ob-step{display:none;animation:slideUp .4s cubic-bezier(.22,.68,0,1) both}
.ob-step.active{display:block}
.ob-step-title{font-family:'Clash Display',sans-serif;font-size:28px;font-weight:700;margin-bottom:6px;letter-spacing:-.5px}
.ob-step-sub{font-size:14px;color:var(--tx2);margin-bottom:28px;line-height:1.6}

/* Avatar picker */
.avatar-picker{
  width:110px;height:110px;border-radius:50%;
  border:3px dashed var(--ln2);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;margin:0 auto 20px;
  transition:all .2s;position:relative;overflow:hidden;
  background:var(--s2);
}
.avatar-picker:hover{border-color:var(--gd);box-shadow:0 0 20px var(--gdx)}
.avatar-picker img{width:100%;height:100%;object-fit:cover;border-radius:50%;display:none}
.avatar-picker .ap-icon{font-size:36px;transition:.2s}
.avatar-picker input{position:absolute;inset:0;opacity:0;cursor:pointer;z-index:5;border-radius:50%}

/* Progress dots */
.ob-dots{display:flex;gap:8px;justify-content:center;margin-bottom:32px}
.ob-dot{width:8px;height:8px;border-radius:4px;background:var(--ln2);transition:all .3s}
.ob-dot.on{background:var(--gd);width:24px}

.ob-field{margin-bottom:16px}
.ob-label{display:block;font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--tx2);margin-bottom:8px}
.ob-input{width:100%;background:var(--s2);border:1px solid var(--ln);border-radius:var(--r2);color:var(--tx);font-family:'Satoshi',sans-serif;font-size:16px;padding:14px 16px;outline:none;transition:border-color .15s}
.ob-input:focus{border-color:var(--gd);box-shadow:0 0 0 3px var(--gdx)}
.ob-select{width:100%;background:var(--s2);border:1px solid var(--ln);border-radius:var(--r2);color:var(--tx);font-family:'Satoshi',sans-serif;font-size:15px;padding:14px 16px;outline:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%233d5070' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;padding-right:40px}
.ob-next{
  width:100%;padding:16px;margin-top:8px;
  background:linear-gradient(135deg,var(--gd),var(--gd2));
  color:#000;border:none;border-radius:var(--r2);
  font-family:'Clash Display',sans-serif;font-size:18px;font-weight:700;
  cursor:pointer;letter-spacing:.3px;transition:all .2s;
  box-shadow:0 6px 24px rgba(240,192,64,.3);
  -webkit-appearance:none;appearance:none;
  position:relative;z-index:10;
  touch-action:manipulation;
}
.ob-next:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(240,192,64,.4)}
.ob-next:active{transform:scale(.98)}
.ob-back{background:none;border:none;color:var(--tx2);font-family:'Satoshi',sans-serif;font-size:14px;cursor:pointer;margin-top:14px;display:block;text-align:center;width:100%;-webkit-appearance:none;appearance:none;position:relative;z-index:10;touch-action:manipulation;}

/* Budget sliders */
.budget-preset{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
.bp-btn{padding:11px;background:var(--s2);border:1px solid var(--ln);border-radius:var(--r2);color:var(--tx2);font-family:'JetBrains Mono',monospace;font-size:11px;cursor:pointer;transition:all .15s;text-align:center}
.bp-btn.on{background:var(--gdx);border-color:var(--gd);color:var(--gd)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOTTOM NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bnav{
  position:fixed;bottom:0;left:0;right:0;
  background:rgba(6,8,15,.95);backdrop-filter:blur(24px);
  border-top:1px solid var(--ln);display:flex;z-index:200;
  padding-bottom:env(safe-area-inset-bottom);
}
.nb{
  flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;
  padding:10px 2px;border:none;background:transparent;
  color:var(--tx3);font-family:'JetBrains Mono',monospace;
  font-size:9px;letter-spacing:.3px;cursor:pointer;transition:color .2s;
}
.nb .ni{font-size:20px;transition:transform .2s}
.nb.on{color:var(--gd)}
.nb.on .ni{transform:scale(1.2)}
.nb-add-wrap{flex:1;display:flex;align-items:center;justify-content:center;padding:6px 2px}
.nb-add-btn{
  width:52px;height:52px;border-radius:50%;
  background:linear-gradient(135deg,var(--gd),var(--gd2));
  border:none;color:#000;font-size:26px;font-weight:700;
  cursor:pointer;box-shadow:0 4px 20px rgba(240,192,64,.4);
  transition:all .2s;display:flex;align-items:center;justify-content:center;
}
.nb-add-btn:active{transform:scale(.92)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAGES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.pg{display:none}
.pg.on{display:block;animation:fadeUp .35s cubic-bezier(.22,.68,0,1) both}
.topbar{display:flex;justify-content:space-between;align-items:center;padding:18px 0 14px}
.topbar-title{font-family:'Clash Display',sans-serif;font-size:26px;font-weight:700;letter-spacing:-.5px}
.topbar-title span{color:var(--gd)}

/* â”€â”€ CARDS â”€â”€ */
.card{background:var(--s1);border:1px solid var(--ln);border-radius:var(--r);padding:18px;margin-bottom:12px}
.card-sm{padding:13px 15px}
.sec-lbl{font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--tx3);margin-bottom:12px}

/* â”€â”€ HERO â”€â”€ */
.hero{
  background:linear-gradient(145deg,var(--s2) 0%,var(--s1) 100%);
  border:1px solid var(--ln);border-radius:var(--r3);
  padding:0;margin-bottom:12px;position:relative;overflow:hidden;
}
.hero-top{padding:22px 22px 16px;position:relative}
.hero-user-row{display:flex;align-items:center;gap:12px;margin-bottom:18px}
.hero-avatar{width:46px;height:46px;border-radius:50%;object-fit:cover;border:2px solid var(--gd);background:var(--s3);flex-shrink:0;font-size:22px;display:flex;align-items:center;justify-content:center}
.hero-avatar img{width:100%;height:100%;border-radius:50%;object-fit:cover}
.hero-username{font-size:13px;font-weight:700;color:var(--tx2)}
.hero-greeting{font-family:'Clash Display',sans-serif;font-size:17px;font-weight:700;color:var(--tx);letter-spacing:-.3px}
.hero-glow{position:absolute;top:-50px;right:-50px;width:180px;height:180px;background:radial-gradient(circle,rgba(240,192,64,.07),transparent 70%);pointer-events:none}
.hero-bal-lbl{font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--tx3);margin-bottom:6px}
.hero-bal{font-family:'Clash Display',sans-serif;font-size:46px;font-weight:700;letter-spacing:-2px;line-height:1}
.hero-bal.pos{color:var(--gr)}.hero-bal.neg{color:var(--rd)}.hero-bal.zer{color:var(--tx)}
.hero-cur{font-size:18px;font-weight:500;color:var(--tx2);margin-right:3px}
.hero-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:0;border-top:1px solid var(--ln);margin-top:16px}
.hst{padding:14px 12px;text-align:center;position:relative}
.hst:not(:last-child)::after{content:'';position:absolute;right:0;top:20%;height:60%;width:1px;background:var(--ln)}
.hst-l{font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:1.5px;text-transform:uppercase;color:var(--tx3);margin-bottom:4px}
.hst-v{font-size:15px;font-weight:800;letter-spacing:-.3px}

/* â”€â”€ BUDGET RING â”€â”€ */
.bbar{margin-bottom:12px}
.bbar-hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:7px}
.bbar-l{font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--tx3)}
.bbar-p{font-family:'Clash Display',sans-serif;font-size:18px;font-weight:700}
.bbar-track{height:8px;background:rgba(255,255,255,.04);border-radius:4px;overflow:hidden}
.bbar-fill{height:100%;border-radius:4px;transition:width .7s cubic-bezier(.22,.68,0,1.3)}
.bbar-fill.s{background:linear-gradient(90deg,var(--gr),#4df598)}
.bbar-fill.w{background:linear-gradient(90deg,var(--gd),#fce44a)}
.bbar-fill.d{background:linear-gradient(90deg,var(--rd),#ff7a8f)}
.bbar-sub{display:flex;justify-content:space-between;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--tx3);margin-top:5px}

/* â”€â”€ ALERTS â”€â”€ */
.alert{border-radius:var(--r2);padding:13px 15px;margin-bottom:10px;display:flex;gap:10px;align-items:flex-start;animation:fadeUp .3s ease}
.alert.w{background:rgba(240,192,64,.08);border:1px solid rgba(240,192,64,.25)}
.alert.d{background:var(--rdx);border:1px solid rgba(255,68,102,.3)}
.alert.g{background:var(--grx);border:1px solid rgba(31,212,122,.3)}
.alert.i{background:var(--blx);border:1px solid rgba(77,159,255,.3)}
.alert-i{font-size:18px;flex-shrink:0;margin-top:1px}
.alert-t{font-size:13px;font-weight:800;margin-bottom:2px}
.alert.w .alert-t{color:var(--gd)}.alert.d .alert-t{color:var(--rd)}
.alert.g .alert-t{color:var(--gr)}.alert.i .alert-t{color:var(--bl)}
.alert-m{font-size:12px;color:var(--tx2);line-height:1.5}

/* â”€â”€ TX ITEMS â”€â”€ */
.txg-h{font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--tx3);margin:16px 0 6px 2px}
.txi{display:flex;align-items:center;gap:11px;padding:12px 13px;background:var(--s1);border:1px solid transparent;border-radius:var(--r2);margin-bottom:5px;transition:all .15s;animation:fadeUp .25s ease both}
.txi:active{transform:scale(.98);border-color:var(--ln)}
.txi-ico{width:42px;height:42px;border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.txi-body{flex:1;min-width:0}
.txi-name{font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.txi-meta{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--tx2);margin-top:2px}
.txi-r{text-align:right;flex-shrink:0}
.txi-amt{font-size:15px;font-weight:800}
.txi-sub{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--tx3);margin-top:2px}
.del-b{background:none;border:none;color:var(--tx3);font-size:14px;cursor:pointer;padding:3px;border-radius:6px;margin-top:3px;transition:color .15s}
.del-b:active{color:var(--rd)}

/* â”€â”€ FORM â”€â”€ */
.type-toggle{display:grid;grid-template-columns:repeat(4,1fr);background:var(--s2);border-radius:var(--r2);padding:4px;margin-bottom:16px;border:1px solid var(--ln);gap:3px}
.tt{padding:10px 4px;border:none;border-radius:8px;font-family:'Satoshi',sans-serif;font-size:12px;font-weight:700;cursor:pointer;background:transparent;color:var(--tx3);transition:all .18s;white-space:nowrap}
.tt.on.inc{background:var(--gr);color:#000;box-shadow:0 3px 12px rgba(31,212,122,.3)}
.tt.on.exp{background:var(--rd);color:#fff;box-shadow:0 3px 12px rgba(255,68,102,.3)}
.tt.on.sav{background:var(--bl);color:#fff;box-shadow:0 3px 12px rgba(77,159,255,.3)}
.tt.on.inv{background:var(--pu);color:#fff;box-shadow:0 3px 12px rgba(157,122,250,.3)}
.fg{margin-bottom:14px}
.fl{display:block;font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--tx2);margin-bottom:7px}
input,select,textarea{width:100%;background:var(--s2);border:1px solid var(--ln);border-radius:var(--r2);color:var(--tx);font-family:'Satoshi',sans-serif;font-size:15px;padding:13px 16px;outline:none;transition:border-color .15s,box-shadow .15s;appearance:none;-webkit-appearance:none}
input:focus,select:focus{border-color:var(--gd);box-shadow:0 0 0 3px var(--gdx)}
input[type=number]{font-family:'JetBrains Mono',monospace}
select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%233d5070' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;padding-right:36px}
.sub-btn{width:100%;padding:16px;background:linear-gradient(135deg,var(--gd),var(--gd2));color:#000;border:none;border-radius:var(--r2);font-family:'Clash Display',sans-serif;font-size:17px;font-weight:700;cursor:pointer;letter-spacing:.3px;transition:all .2s;margin-top:4px;box-shadow:0 6px 20px rgba(240,192,64,.25)}
.sub-btn:active{transform:scale(.98);opacity:.9}

/* â”€â”€ GOALS â”€â”€ */
.goal-card{background:var(--s1);border:1px solid var(--ln);border-radius:var(--r);padding:18px;margin-bottom:10px;position:relative;overflow:hidden}
.goal-card::after{content:'';position:absolute;inset:0;background:radial-gradient(circle at 100% 0%,rgba(255,255,255,.02),transparent 60%);pointer-events:none}
.goal-bar{height:7px;background:rgba(255,255,255,.05);border-radius:4px;overflow:hidden;margin-bottom:10px}
.goal-fill{height:100%;border-radius:4px;transition:width .7s cubic-bezier(.22,.68,0,1.3)}
.goal-af-btn{width:100%;margin-top:10px;padding:9px;background:var(--gdx);border:1px solid rgba(240,192,64,.2);border-radius:var(--r2);color:var(--gd);font-family:'Satoshi',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:all .15s}
.goal-af-btn:active{background:var(--gd);color:#000}
.goal-del{position:absolute;top:14px;right:14px;background:none;border:none;color:var(--tx3);font-size:15px;cursor:pointer}

/* â”€â”€ MODALS â”€â”€ */
.modal-ov{position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(8px);z-index:300;display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity .25s}
.modal-ov.on{opacity:1;pointer-events:all}
.modal-box{background:var(--s1);border:1px solid var(--ln);border-radius:24px 24px 0 0;padding:24px 20px;width:100%;max-width:640px;transform:translateY(20px);transition:transform .25s;max-height:90vh;overflow-y:auto}
.modal-ov.on .modal-box{transform:translateY(0)}
.modal-title{font-family:'Clash Display',sans-serif;font-size:22px;font-weight:700;margin-bottom:18px}
.modal-btns{display:flex;gap:10px;margin-top:18px}
.mbt{flex:1;padding:14px;border:none;border-radius:var(--r2);font-family:'Satoshi',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:all .15s}
.mbt.cancel{background:var(--s2);color:var(--tx2);border:1px solid var(--ln)}
.mbt.confirm{background:var(--rd);color:#fff}
.mbt.gold{background:var(--gd);color:#000}

/* â”€â”€ SEGTABS â”€â”€ */
.segtabs{display:flex;gap:6px;margin-bottom:16px;overflow-x:auto;padding-bottom:3px;scrollbar-width:none}
.segtabs::-webkit-scrollbar{display:none}
.stab{flex-shrink:0;padding:7px 16px;border:1px solid var(--ln2);border-radius:20px;font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600;letter-spacing:.8px;cursor:pointer;background:transparent;color:var(--tx2);transition:all .15s}
.stab.on{background:var(--gd);color:#000;border-color:var(--gd);box-shadow:0 4px 16px rgba(240,192,64,.2)}

/* â”€â”€ REPORT STATS â”€â”€ */
.r-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}
.rbox{background:var(--s1);border:1px solid var(--ln);border-radius:var(--r2);padding:16px}
.rbox-l{font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--tx3);margin-bottom:5px}
.rbox-v{font-family:'Clash Display',sans-serif;font-size:22px;font-weight:700}
.rbox-v.g{color:var(--gr)}.rbox-v.r{color:var(--rd)}.rbox-v.b{color:var(--bl)}.rbox-v.go{color:var(--gd)}.rbox-v.p{color:var(--pu)}.rbox-v.t{color:var(--tl)}

/* â”€â”€ DONUT â”€â”€ */
.donut-wrap{display:flex;gap:18px;align-items:center}
.donut-leg{flex:1;display:flex;flex-direction:column;gap:8px}
.dl-row{display:flex;align-items:center;gap:8px}
.dl-dot{width:9px;height:9px;border-radius:50%;flex-shrink:0}
.dl-name{font-size:12px;font-weight:600;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.dl-val{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--tx2)}

/* â”€â”€ SUGGESTIONS â”€â”€ */
.sugg-item{display:flex;gap:12px;padding:14px;background:var(--s2);border-radius:var(--r2);margin-bottom:8px}
.sugg-ico{font-size:22px;flex-shrink:0}
.sugg-t{font-size:13px;font-weight:800;margin-bottom:3px}
.sugg-d{font-size:12px;color:var(--tx2);line-height:1.6}

/* â”€â”€ EMPTY â”€â”€ */
.empty{text-align:center;padding:40px 20px;color:var(--tx3);font-family:'JetBrains Mono',monospace;font-size:11px;line-height:2;border:1px dashed var(--ln);border-radius:var(--r)}
.empty .em{font-size:34px;display:block;margin-bottom:10px}

/* â”€â”€ TOAST â”€â”€ */
.toast{position:fixed;bottom:85px;left:50%;transform:translateX(-50%) translateY(10px);background:var(--s2);border:1px solid var(--ln2);color:var(--tx);padding:11px 20px;border-radius:30px;font-family:'JetBrains Mono',monospace;font-size:11px;opacity:0;transition:all .25s;z-index:500;pointer-events:none;white-space:nowrap;box-shadow:0 8px 30px rgba(0,0,0,.5)}
.toast.on{opacity:1;transform:translateX(-50%) translateY(0)}

/* â”€â”€ DL BUTTON â”€â”€ */
.dl-btn{display:flex;align-items:center;justify-content:center;gap:8px;padding:13px;background:var(--s2);border:1px solid var(--ln2);border-radius:var(--r2);color:var(--tx);font-family:'Satoshi',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:all .15s;width:100%;margin-bottom:8px}
.dl-btn:hover{border-color:var(--gd);color:var(--gd)}
.dl-btn:active{transform:scale(.98)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AI CHATBOT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.chat-fab{
  position:fixed;bottom:88px;right:20px;z-index:190;
  width:56px;height:56px;border-radius:50%;
  background:linear-gradient(135deg,#4d9fff,#a78bfa);
  border:none;cursor:pointer;
  box-shadow:0 6px 24px rgba(77,159,255,.4);
  display:flex;align-items:center;justify-content:center;
  font-size:26px;transition:all .2s;
}
.chat-fab:hover{transform:scale(1.08);box-shadow:0 10px 32px rgba(77,159,255,.5)}
.chat-fab:active{transform:scale(.94)}
.chat-badge{
  position:absolute;top:-4px;right:-4px;
  width:18px;height:18px;border-radius:50%;
  background:var(--rd);border:2px solid var(--bg);
  font-size:10px;font-weight:700;
  display:flex;align-items:center;justify-content:center;color:#fff;
  animation:pulse 2s ease infinite;
}
.chat-panel{
  position:fixed;inset:0;z-index:250;
  background:var(--bg);display:flex;flex-direction:column;
  transform:translateY(100%);transition:transform .35s cubic-bezier(.22,.68,0,1);
}
.chat-panel.on{transform:translateY(0)}
.chat-header{
  display:flex;align-items:center;gap:12px;
  padding:16px 20px;border-bottom:1px solid var(--ln);
  background:var(--s1);
}
.chat-ai-avatar{
  width:44px;height:44px;border-radius:50%;
  background:linear-gradient(135deg,#4d9fff,#a78bfa);
  display:flex;align-items:center;justify-content:center;font-size:22px;
  flex-shrink:0;box-shadow:0 4px 16px rgba(77,159,255,.3);
}
.chat-ai-name{font-size:16px;font-weight:800}
.chat-ai-sub{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--tx2);margin-top:1px}
.chat-status{width:8px;height:8px;border-radius:50%;background:var(--gr);margin-top:1px;animation:pulse 2s ease infinite}
.chat-close{margin-left:auto;background:var(--s2);border:1px solid var(--ln);border-radius:8px;padding:8px 12px;color:var(--tx2);cursor:pointer;font-size:13px;font-family:'Satoshi',sans-serif;font-weight:700}
.chat-messages{flex:1;overflow-y:auto;padding:16px 16px 0}
.chat-msg{display:flex;gap:10px;margin-bottom:14px;animation:fadeUp .25s ease both}
.chat-msg.user{flex-direction:row-reverse}
.msg-bubble{max-width:80%;padding:12px 15px;border-radius:18px;font-size:14px;line-height:1.6}
.chat-msg.ai .msg-bubble{background:var(--s2);border:1px solid var(--ln);border-radius:4px 18px 18px 18px;color:var(--tx)}
.chat-msg.user .msg-bubble{background:linear-gradient(135deg,var(--bl),var(--pu));color:#fff;border-radius:18px 18px 4px 18px}
.msg-ava{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;margin-top:2px}
.msg-ava.ai{background:linear-gradient(135deg,#4d9fff,#a78bfa)}
.msg-ava.user{background:var(--gd);color:#000;font-size:14px;font-weight:800}
.typing{display:flex;gap:4px;align-items:center;padding:4px 2px}
.typing span{width:7px;height:7px;border-radius:50%;background:var(--tx3)}
.typing span:nth-child(1){animation:blink .9s .0s ease infinite}
.typing span:nth-child(2){animation:blink .9s .15s ease infinite}
.typing span:nth-child(3){animation:blink .9s .3s ease infinite}
.chat-input-area{padding:12px 16px;border-top:1px solid var(--ln);background:var(--s1);display:flex;gap:10px;padding-bottom:calc(12px + env(safe-area-inset-bottom))}
.chat-input{flex:1;background:var(--s2);border:1px solid var(--ln);border-radius:24px;color:var(--tx);font-family:'Satoshi',sans-serif;font-size:15px;padding:12px 18px;outline:none;transition:border-color .15s;resize:none;height:46px}
.chat-input:focus{border-color:var(--bl)}
.chat-send{width:46px;height:46px;border-radius:50%;background:linear-gradient(135deg,var(--bl),var(--pu));border:none;color:#fff;font-size:20px;cursor:pointer;flex-shrink:0;transition:all .15s;box-shadow:0 4px 16px rgba(77,159,255,.3)}
.chat-send:active{transform:scale(.9)}
.quick-btns{display:flex;gap:6px;overflow-x:auto;padding:10px 16px 0;scrollbar-width:none}
.quick-btns::-webkit-scrollbar{display:none}
.qb{flex-shrink:0;padding:7px 14px;background:var(--s2);border:1px solid var(--ln2);border-radius:20px;font-size:12px;font-weight:600;color:var(--tx2);cursor:pointer;transition:all .15s;white-space:nowrap}
.qb:active{background:var(--blx);color:var(--bl);border-color:var(--bl)}

/* â”€â”€ PROFILE PAGE â”€â”€ */
.profile-hero{
  background:linear-gradient(145deg,var(--s2),var(--s1));
  border:1px solid var(--ln);border-radius:var(--r3);
  padding:28px;margin-bottom:14px;text-align:center;
}
.pf-avatar-wrap{position:relative;display:inline-block;margin-bottom:16px;cursor:pointer;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
.pf-avatar{width:90px;height:90px;border-radius:50%;overflow:hidden;border:3px solid var(--gd);background:var(--s3);display:flex;align-items:center;justify-content:center;font-size:40px}
.pf-avatar img{width:100%;height:100%;border-radius:50%;object-fit:cover;display:block}
.pf-edit-badge{
  position:absolute;bottom:2px;right:2px;
  width:26px;height:26px;border-radius:50%;
  background:var(--gd);color:#000;font-size:14px;
  display:flex;align-items:center;justify-content:center;
  border:2px solid var(--bg);pointer-events:none;
}
.pf-name{font-family:'Clash Display',sans-serif;font-size:26px;font-weight:700;letter-spacing:-.5px}
.pf-sub{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--tx2);margin-top:4px}
.pf-badge{display:inline-block;margin-top:10px;padding:5px 14px;background:var(--gdx);border:1px solid rgba(240,192,64,.25);border-radius:20px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--gd)}
.stat-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:18px}
.stat-box{background:rgba(255,255,255,.03);border-radius:var(--r2);padding:14px;text-align:center}
.stat-box-l{font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--tx3);margin-bottom:4px}
.stat-box-v{font-family:'Clash Display',sans-serif;font-size:20px;font-weight:700}
.set-item{display:flex;justify-content:space-between;align-items:center;padding:15px 0;border-bottom:1px solid var(--ln)}
.set-item:last-child{border-bottom:none}
.set-item-l{font-size:14px;font-weight:700}
.set-item-s{font-size:12px;color:var(--tx2);margin-top:2px}
.set-item-v{font-family:'JetBrains Mono',monospace;font-size:13px;color:var(--gd);font-weight:600;cursor:pointer}

/* â”€â”€ INVESTMENTS â”€â”€ */
.inv-card{background:var(--s1);border:1px solid var(--ln);border-radius:var(--r);padding:16px;margin-bottom:8px;display:flex;align-items:center;gap:12px}
.inv-ico{width:42px;height:42px;border-radius:11px;background:var(--pux);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.inv-body{flex:1;min-width:0}
.inv-name{font-size:14px;font-weight:700}
.inv-type{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--tx2);margin-top:2px}
.inv-right{text-align:right}
.inv-val{font-size:16px;font-weight:800;color:var(--pu)}
.inv-ret{font-family:'JetBrains Mono',monospace;font-size:10px;margin-top:2px}
.inv-ret.up{color:var(--gr)}.inv-ret.dn{color:var(--rd)}

/* â”€â”€ SAV CARD â”€â”€ */
.sav-item{background:var(--s2);border-radius:var(--r2);padding:14px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;gap:12px}
.sav-item-l{font-size:14px;font-weight:700}
.sav-item-s{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--tx2);margin-top:2px}
.sav-item-v{font-family:'Clash Display',sans-serif;font-size:20px;font-weight:700;color:var(--bl)}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ONBOARDING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="onboarding">
  <div class="ob-logo">Vault LK</div>
  <div class="ob-tagline">Smart Finance Â· Sri Lanka</div>

  <div class="ob-steps">
    <div class="ob-dots">
      <div class="ob-dot on" id="dot0"></div>
      <div class="ob-dot" id="dot1"></div>
      <div class="ob-dot" id="dot2"></div>
    </div>

    <!-- Step 0: Welcome + Photo -->
    <div class="ob-step active" id="ob-step-0">
      <div class="ob-step-title">Welcome ğŸ‘‹</div>
      <div class="ob-step-sub">Let's set up your personal finance profile. Your data stays 100% on your device.</div>
      <div class="avatar-picker" id="avatarPicker" onclick="document.getElementById('avatarInput').click()" ontouchend="event.preventDefault();document.getElementById('avatarInput').click()">
        <span class="ap-icon">ğŸ“·</span>
        <img id="avatarPreview" alt="profile">
      </div>
      <input type="file" accept="image/*" id="avatarInput" style="display:none" onchange="handleAvatarUpload(this)">
      <div class="ob-field">
        <label class="ob-label">Your Name</label>
        <input class="ob-input" type="text" id="ob-name" placeholder="e.g. Kasun Perera" maxlength="32">
      </div>
      <div class="ob-field">
        <label class="ob-label">District</label>
        <select class="ob-select" id="ob-city">
          <option>Colombo</option><option>Gampaha</option><option>Kalutara</option>
          <option>Kandy</option><option>Matale</option><option>Nuwara Eliya</option>
          <option>Galle</option><option>Matara</option><option>Hambantota</option>
          <option>Jaffna</option><option>Kilinochchi</option><option>Mannar</option>
          <option>Mullaitivu</option><option>Vavuniya</option>
          <option>Trincomalee</option><option>Batticaloa</option><option>Ampara</option>
          <option>Kurunegala</option><option>Puttalam</option>
          <option>Anuradhapura</option><option>Polonnaruwa</option>
          <option>Badulla</option><option>Monaragala</option>
          <option>Ratnapura</option><option>Kegalle</option>
        </select>
      </div>
      <div class="ob-field">
        <label class="ob-label">Email <span style="color:var(--tx3);font-size:9px">(for budget alerts)</span></label>
        <input class="ob-input" type="text" inputmode="email" autocomplete="email" id="ob-email" placeholder="e.g. kasun@gmail.com">
      </div>
      <button class="ob-next" onclick="obNext()" ontouchend="event.preventDefault();obNext()">Continue â†’</button>
      <button class="ob-back" style="margin-top:10px" onclick="obSkipToLaunch()" ontouchend="event.preventDefault();obSkipToLaunch()">Skip setup, start now â†’</button>
    </div>

    <!-- Step 1: Job & Income -->
    <div class="ob-step" id="ob-step-1">
      <div class="ob-step-title">Your Finances ğŸ’¼</div>
      <div class="ob-step-sub">This helps Vault LK give you personalized advice for Sri Lanka's economy.</div>
      <div class="ob-field">
        <label class="ob-label">Occupation</label>
        <select class="ob-select" id="ob-job">
          <option>Government Employee</option><option>Private Sector</option><option>Self Employed / Business</option>
          <option>Freelancer / Remote</option><option>Student</option><option>Retired</option><option>Other</option>
        </select>
      </div>
      <div class="ob-field">
        <label class="ob-label">Monthly Income (approx. Rs.)</label>
        <input class="ob-input" type="number" id="ob-income" placeholder="e.g. 85000" inputmode="numeric">
      </div>
      <div class="ob-field">
        <label class="ob-label">Primary Finance Goal</label>
        <select class="ob-select" id="ob-goal">
          <option>Save more money</option><option>Buy a car</option><option>Buy a house</option>
          <option>Start a business</option><option>Travel</option><option>Retire early</option>
          <option>Pay off debt</option><option>Build investments</option>
        </select>
      </div>
      <button class="ob-next" onclick="obNext()" ontouchend="event.preventDefault();obNext()">Continue â†’</button>
      <button class="ob-back" onclick="obBack()" ontouchend="event.preventDefault();obBack()">â† Back</button>
      <button class="ob-back" style="margin-top:2px;color:var(--tx3)" onclick="obSkipToLaunch()" ontouchend="event.preventDefault();obSkipToLaunch()">Skip & launch â†’</button>
    </div>

    <!-- Step 2: Budget Setup -->
    <div class="ob-step" id="ob-step-2">
      <div class="ob-step-title">Set Your Budget ğŸ¯</div>
      <div class="ob-step-sub">Quick presets based on your income, or set custom limits.</div>
      <div id="ob-presets" class="budget-preset"></div>
      <div class="ob-field">
        <label class="ob-label">Monthly Spending Limit (Rs.)</label>
        <input class="ob-input" type="number" id="ob-monthly" placeholder="e.g. 60000" inputmode="numeric">
      </div>
      <div class="ob-field">
        <label class="ob-label">Daily Limit (Rs.)</label>
        <input class="ob-input" type="number" id="ob-daily" placeholder="e.g. 2000" inputmode="numeric">
      </div>
      <button class="ob-next" onclick="obFinish()" ontouchend="event.preventDefault();obFinish()" style="background:linear-gradient(135deg,var(--gr),#0ca854);box-shadow:0 6px 24px rgba(31,212,122,.3)">ğŸš€ Launch Vault LK</button>
      <button class="ob-back" onclick="obBack()" ontouchend="event.preventDefault();obBack()">â† Back</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN APP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app" class="hidden">

<!-- BOTTOM NAV -->
<nav class="bnav">
  <button class="nb on" id="nb-home" onclick="go('home')"><span class="ni">ğŸ </span>Home</button>
  <button class="nb" id="nb-txns" onclick="go('txns')"><span class="ni">ğŸ“‹</span>History</button>
  <div class="nb-add-wrap"><button class="nb-add-btn" onclick="go('add')">ï¼‹</button></div>
  <button class="nb" id="nb-goals" onclick="go('goals')"><span class="ni">ğŸ¯</span>Goals</button>
  <button class="nb" id="nb-profile" onclick="go('profile')"><span class="ni">ğŸ‘¤</span>Profile</button>
</nav>

<!-- AI Chat FAB -->
<button class="chat-fab" id="chatFab" onclick="openChat()">ğŸ¤–<span class="chat-badge">AI</span></button>

<!-- â”€â”€ HOME â”€â”€ -->
<div class="pg on" id="pg-home">
<div class="shell">
  <div class="hero">
    <div class="hero-top">
      <div class="hero-glow"></div>
      <div class="hero-user-row">
        <div class="hero-avatar" id="heroAvatar">ğŸ˜Š</div>
        <div>
          <div class="hero-username" id="heroUsername">Good morning</div>
          <div class="hero-greeting" id="heroGreeting">Loading...</div>
        </div>
      </div>
      <div class="hero-bal-lbl">NET WORTH</div>
      <div class="hero-bal zer" id="heroNW"><span class="hero-cur">Rs.</span><span id="heroNWAmt">0</span></div>
    </div>
    <div class="hero-stats" id="heroStats"></div>
  </div>
  <div id="alertArea"></div>
  <div id="budgetSection"></div>
  <!-- Quick stats row -->
  <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px" id="quickRow"></div>
  <div class="sh" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <span style="font-size:15px;font-weight:800">Recent</span>
    <button onclick="go('txns')" style="background:none;border:none;color:var(--gd);font-size:13px;font-weight:700;cursor:pointer;font-family:'Satoshi',sans-serif">See all â†’</button>
  </div>
  <div id="recentList"></div>
</div>
</div>

<!-- â”€â”€ TRANSACTIONS â”€â”€ -->
<div class="pg" id="pg-txns">
<div class="shell">
  <div class="topbar"><div class="topbar-title">History</div></div>
  <div class="segtabs" id="txFilterTabs">
    <button class="stab on" onclick="setTxF('all',this)">All</button>
    <button class="stab" onclick="setTxF('income',this)">Income</button>
    <button class="stab" onclick="setTxF('expense',this)">Expense</button>
    <button class="stab" onclick="setTxF('saving',this)">Savings</button>
    <button class="stab" onclick="setTxF('investment',this)">Invest</button>
  </div>
  <div id="fullTxList"></div>
</div>
</div>

<!-- â”€â”€ ADD â”€â”€ -->
<div class="pg" id="pg-add">
<div class="shell">
  <div class="topbar"><div class="topbar-title">Add Entry</div></div>
  <div class="type-toggle">
    <button class="tt on inc" id="tt-income" onclick="setFT('income')">ï¼‹ Income</button>
    <button class="tt exp" id="tt-expense" onclick="setFT('expense')">ï¼ Expense</button>
    <button class="tt sav" id="tt-saving" onclick="setFT('saving')">ğŸ’™ Save</button>
    <button class="tt inv" id="tt-investment" onclick="setFT('investment')">ğŸ“ˆ Invest</button>
  </div>
  <div class="card">
    <div class="fg"><label class="fl">Amount (Rs.)</label><input type="number" id="fAmt" placeholder="0.00" min="0" step="0.01" inputmode="decimal"></div>
    <div class="fg"><label class="fl">Description</label><input type="text" id="fDesc" placeholder="e.g. Keells Supermarket, Monthly Salary..."></div>
    <div class="fg"><label class="fl">Category</label><select id="fCat"></select></div>
    <div class="fg"><label class="fl">Date</label><input type="date" id="fDate"></div>
    <div class="fg"><label class="fl">Note (optional)</label><input type="text" id="fNote" placeholder="Any extra details..."></div>
    <button class="sub-btn" onclick="addTx()">Add Entry</button>
  </div>
</div>
</div>

<!-- â”€â”€ GOALS â”€â”€ -->
<div class="pg" id="pg-goals">
<div class="shell">
  <div class="topbar">
    <div class="topbar-title">Goals ğŸ¯</div>
    <button onclick="openGoalModal()" style="background:var(--gdx);border:1px solid rgba(240,192,64,.25);border-radius:20px;padding:7px 16px;color:var(--gd);font-family:'Satoshi',sans-serif;font-size:13px;font-weight:700;cursor:pointer">ï¼‹ New</button>
  </div>
  <div id="goalsList"></div>
</div>
</div>

<!-- â”€â”€ PROFILE â”€â”€ -->
<div class="pg" id="pg-profile">
<div class="shell">
  <div class="topbar"><div class="topbar-title">Profile</div></div>

  <div class="profile-hero">
    <div class="pf-avatar-wrap" onclick="document.getElementById('pfPhotoInput').click()" ontouchend="event.preventDefault();document.getElementById('pfPhotoInput').click()">
      <div class="pf-avatar" id="pfAvatar">ğŸ˜Š</div>
      <div class="pf-edit-badge">âœï¸</div>
    </div>
    <input type="file" id="pfPhotoInput" accept="image/*" style="display:none" onchange="handleProfilePhoto(this)">
    <div class="pf-name" id="pfName">â€”</div>
    <div class="pf-sub" id="pfSub">â€”</div>
    <div class="pf-badge" id="pfBadge">ğŸŒŸ Vault Member</div>
    <div class="stat-row" id="pfStats"></div>
  </div>

  <!-- Savings Accounts -->
  <div class="card">
    <div class="sec-lbl">Savings Accounts ğŸ¦</div>
    <div id="savAccountsList"></div>
    <button onclick="openSavModal()" style="width:100%;padding:12px;background:var(--blx);border:1px solid rgba(77,159,255,.25);border-radius:var(--r2);color:var(--bl);font-size:13px;font-weight:700;cursor:pointer;margin-top:8px;font-family:'Satoshi',sans-serif">ï¼‹ Add Account</button>
  </div>

  <!-- Investments -->
  <div class="card">
    <div class="sec-lbl">Investment Portfolio ğŸ“ˆ</div>
    <div id="investList"></div>
    <button onclick="openInvModal()" style="width:100%;padding:12px;background:var(--pux);border:1px solid rgba(157,122,250,.25);border-radius:var(--r2);color:var(--pu);font-size:13px;font-weight:700;cursor:pointer;margin-top:8px;font-family:'Satoshi',sans-serif">ï¼‹ Add Investment</button>
  </div>

  <!-- Budget Settings -->
  <div class="card">
    <div class="sec-lbl">Budget Settings</div>
    <div class="set-item"><div><div class="set-item-l">Monthly Budget</div><div class="set-item-s" id="set-monthly-sub">Not set</div></div><div class="set-item-v" onclick="openBudgetModal('monthly')">Set â†’</div></div>
    <div class="set-item"><div><div class="set-item-l">Weekly Budget</div><div class="set-item-s" id="set-weekly-sub">Not set</div></div><div class="set-item-v" onclick="openBudgetModal('weekly')">Set â†’</div></div>
    <div class="set-item"><div><div class="set-item-l">Daily Budget</div><div class="set-item-s" id="set-daily-sub">Not set</div></div><div class="set-item-v" onclick="openBudgetModal('daily')">Set â†’</div></div>
    <div class="set-item"><div><div class="set-item-l">Alert Threshold</div><div class="set-item-s">Warn at % of budget</div></div><div class="set-item-v" onclick="openThreshModal()" id="set-thresh">80%</div></div>
  </div>

  <!-- Email Notifications -->
  <div class="card">
    <div class="sec-lbl">Email Notifications ğŸ“§</div>
    <div class="set-item">
      <div><div class="set-item-l">Email Address</div><div class="set-item-s" id="set-email-sub">Not set</div></div>
      <div class="set-item-v" onclick="openEmailModal()">Edit â†’</div>
    </div>
    <div class="set-item">
      <div><div class="set-item-l">Budget Breach Alerts</div><div class="set-item-s">Auto-email when limit exceeded</div></div>
      <div id="emailToggle" onclick="toggleEmailNotify()" style="width:42px;height:24px;border-radius:12px;background:var(--gr);position:relative;transition:background .2s;cursor:pointer;flex-shrink:0">
        <div id="emailToggleThumb" style="width:18px;height:18px;border-radius:50%;background:#fff;position:absolute;top:3px;left:21px;transition:left .2s;box-shadow:0 1px 4px rgba(0,0,0,.3)"></div>
      </div>
    </div>
    <div class="set-item">
      <div><div class="set-item-l">Daily Morning Summary</div><div class="set-item-s" id="set-daily-email-sub">Every day at 8:00 AM</div></div>
      <div id="dailyEmailToggle" onclick="toggleSchedule('daily')" style="width:42px;height:24px;border-radius:12px;background:var(--ln2);position:relative;transition:background .2s;cursor:pointer;flex-shrink:0">
        <div id="dailyEmailThumb" style="width:18px;height:18px;border-radius:50%;background:#fff;position:absolute;top:3px;left:3px;transition:left .2s;box-shadow:0 1px 4px rgba(0,0,0,.3)"></div>
      </div>
    </div>
    <div class="set-item">
      <div><div class="set-item-l">Weekly Report</div><div class="set-item-s" id="set-weekly-email-sub">Every Monday at 9:00 AM</div></div>
      <div id="weeklyEmailToggle" onclick="toggleSchedule('weekly')" style="width:42px;height:24px;border-radius:12px;background:var(--ln2);position:relative;transition:background .2s;cursor:pointer;flex-shrink:0">
        <div id="weeklyEmailThumb" style="width:18px;height:18px;border-radius:50%;background:#fff;position:absolute;top:3px;left:3px;transition:left .2s;box-shadow:0 1px 4px rgba(0,0,0,.3)"></div>
      </div>
    </div>
    <div class="set-item">
      <div><div class="set-item-l">Monthly Report</div><div class="set-item-s" id="set-monthly-email-sub">1st of every month</div></div>
      <div id="monthlyEmailToggle" onclick="toggleSchedule('monthly')" style="width:42px;height:24px;border-radius:12px;background:var(--ln2);position:relative;transition:background .2s;cursor:pointer;flex-shrink:0">
        <div id="monthlyEmailThumb" style="width:18px;height:18px;border-radius:50%;background:#fff;position:absolute;top:3px;left:3px;transition:left .2s;box-shadow:0 1px 4px rgba(0,0,0,.3)"></div>
      </div>
    </div>
    <div style="font-size:11px;color:var(--tx3);font-family:'JetBrains Mono',monospace;margin-top:8px;padding:10px;background:var(--s2);border-radius:var(--r2);line-height:1.7">
      ğŸ“¬ Emails open your mail app pre-filled and ready to send. Keep the app open or visit it daily to trigger scheduled emails. Budget breach alerts fire instantly when limit is crossed.
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px">
      <button onclick="sendTestEmail()" style="padding:11px;background:var(--blx);border:1px solid rgba(77,159,255,.25);border-radius:var(--r2);color:var(--bl);font-size:12px;font-weight:700;cursor:pointer;font-family:'Satoshi',sans-serif">ğŸ“§ Test Email</button>
      <button onclick="sendDailySummaryEmail(true)" style="padding:11px;background:var(--gdx);border:1px solid rgba(240,192,64,.25);border-radius:var(--r2);color:var(--gd);font-size:12px;font-weight:700;cursor:pointer;font-family:'Satoshi',sans-serif">ğŸ“Š Send Summary Now</button>
    </div>
  </div>

  <!-- Reports -->
  <div class="card">
    <div class="sec-lbl">Reports</div>
    <div class="segtabs" id="reportTabs" style="margin-bottom:16px">
      <button class="stab on" onclick="setRP('monthly',this)">Month</button>
      <button class="stab" onclick="setRP('weekly',this)">Week</button>
      <button class="stab" onclick="setRP('daily',this)">Today</button>
      <button class="stab" onclick="setRP('annually',this)">Year</button>
    </div>
    <div id="reportContent"></div>
    <div style="margin-top:14px">
      <button class="dl-btn" onclick="downloadCSV()">ğŸ“¥ Download CSV</button>
      <button class="dl-btn" onclick="downloadPDF()">ğŸ“„ Download PDF</button>
    </div>
  </div>

  <!-- Danger -->
  <div class="card">
    <button onclick="confirmClear()" style="width:100%;padding:14px;background:var(--rdx);border:1px solid rgba(255,68,102,.3);border-radius:var(--r2);color:var(--rd);font-size:14px;font-weight:700;cursor:pointer;font-family:'Satoshi',sans-serif">ğŸ—‘ï¸ Clear All Data</button>
  </div>
</div>
</div>

</div><!-- end #app -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     AI CHAT PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="chat-panel" id="chatPanel">
  <div class="chat-header">
    <div class="chat-ai-avatar">ğŸ¤–</div>
    <div>
      <div class="chat-ai-name">Vault AI</div>
      <div style="display:flex;align-items:center;gap:6px"><div class="chat-status"></div><div class="chat-ai-sub" id="chatStatusTxt">Your personal finance advisor</div></div>
    </div>
    <button class="chat-close" onclick="closeChat()">âœ• Close</button>
  </div>
  <div class="quick-btns" id="quickBtns">
    <button class="qb" onclick="askQuick('How am I doing this month?')">ğŸ“Š Monthly summary</button>
    <button class="qb" onclick="askQuick('How can I save more money?')">ğŸ’° Save more</button>
    <button class="qb" onclick="askQuick('Analyze my spending habits')">ğŸ” Spending habits</button>
    <button class="qb" onclick="askQuick('Help me reach my goals faster')">ğŸ¯ Goal advice</button>
    <button class="qb" onclick="askQuick('Best investments for Sri Lanka?')">ğŸ“ˆ Investment tips</button>
    <button class="qb" onclick="askQuick('How to budget better in Sri Lanka?')">ğŸ‡±ğŸ‡° LK budget tips</button>
  </div>
  <div class="chat-messages" id="chatMessages"></div>
  <div class="chat-input-area">
    <input class="chat-input" id="chatInput" placeholder="Ask me anything about your finances..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat()}">
    <button class="chat-send" onclick="sendChat()">â¤</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODALS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-ov" id="deleteModal"><div class="modal-box"><div class="modal-title">Delete?</div><p style="font-size:13px;color:var(--tx2)">Cannot be undone.</p><div class="modal-btns"><button class="mbt cancel" onclick="closeMod('deleteModal')">Cancel</button><button class="mbt confirm" onclick="confirmDelete()">Delete</button></div></div></div>

<div class="modal-ov" id="goalModal">
  <div class="modal-box">
    <div class="modal-title" id="goalModalTitle">New Goal</div>
    <div class="fg"><label class="fl">Goal Name</label><input type="text" id="gName" placeholder="e.g. Buy BMW 3 Series, Emergency Fund"></div>
    <div class="fg"><label class="fl">Target Amount (Rs.)</label><input type="number" id="gTarget" placeholder="e.g. 8500000" inputmode="numeric"></div>
    <div class="fg"><label class="fl">Already Saved (Rs.)</label><input type="number" id="gSaved" placeholder="0" inputmode="numeric"></div>
    <div class="fg"><label class="fl">Monthly Contribution (Rs.)</label><input type="number" id="gMonthly" placeholder="e.g. 25000" inputmode="numeric"></div>
    <div class="fg"><label class="fl">Icon Emoji</label><input type="text" id="gEmoji" placeholder="ğŸš—" maxlength="2"></div>
    <div class="fg"><label class="fl">Color</label><select id="gColor"><option value="var(--gd)">Gold</option><option value="var(--gr)">Green</option><option value="var(--bl)">Blue</option><option value="var(--pu)">Purple</option><option value="var(--rd)">Red</option><option value="var(--tl)">Teal</option></select></div>
    <div class="modal-btns"><button class="mbt cancel" onclick="closeMod('goalModal')">Cancel</button><button class="mbt gold" onclick="saveGoal()">Save Goal</button></div>
  </div>
</div>

<div class="modal-ov" id="fundModal"><div class="modal-box"><div class="modal-title">Add Funds ğŸ’°</div><div class="fg"><label class="fl">Amount (Rs.)</label><input type="number" id="gfAmt" placeholder="0.00" inputmode="decimal"></div><div class="modal-btns"><button class="mbt cancel" onclick="closeMod('fundModal')">Cancel</button><button class="mbt gold" onclick="fundGoal()">Add</button></div></div></div>

<div class="modal-ov" id="savModal"><div class="modal-box"><div class="modal-title">Savings Account ğŸ¦</div><div class="fg"><label class="fl">Account Name</label><input type="text" id="saName" placeholder="e.g. NSB, SDB, Sampath"></div><div class="fg"><label class="fl">Balance (Rs.)</label><input type="number" id="saBal" placeholder="0.00" inputmode="decimal"></div><div class="fg"><label class="fl">Interest Rate % (annual)</label><input type="number" id="saRate" placeholder="e.g. 8.5" step="0.1" inputmode="decimal"></div><div class="modal-btns"><button class="mbt cancel" onclick="closeMod('savModal')">Cancel</button><button class="mbt gold" onclick="saveSavAcc()">Save</button></div></div></div>

<div class="modal-ov" id="invModal"><div class="modal-box"><div class="modal-title">Investment ğŸ“ˆ</div><div class="fg"><label class="fl">Name</label><input type="text" id="invName" placeholder="e.g. NDB Unit Trust, Dialog Shares"></div><div class="fg"><label class="fl">Type</label><select id="invType"><option>Unit Trust</option><option>Fixed Deposit</option><option>Shares (CSE)</option><option>Gold</option><option>Real Estate</option><option>Cryptocurrency</option><option>Other</option></select></div><div class="fg"><label class="fl">Invested Amount (Rs.)</label><input type="number" id="invCost" placeholder="0.00" inputmode="decimal"></div><div class="fg"><label class="fl">Current Value (Rs.)</label><input type="number" id="invVal" placeholder="0.00" inputmode="decimal"></div><div class="modal-btns"><button class="mbt cancel" onclick="closeMod('invModal')">Cancel</button><button class="mbt gold" onclick="saveInv()">Save</button></div></div></div>

<div class="modal-ov" id="budgetModal"><div class="modal-box"><div class="modal-title" id="budgetModalTitle">Set Budget</div><div class="fg"><label class="fl" id="budgetModalLbl">Amount (Rs.)</label><input type="number" id="bAmt" placeholder="0.00" inputmode="numeric"></div><div class="modal-btns"><button class="mbt cancel" onclick="closeMod('budgetModal')">Cancel</button><button class="mbt gold" onclick="saveBudget()">Save</button></div></div></div>

<div class="modal-ov" id="threshModal"><div class="modal-box"><div class="modal-title">Alert Threshold</div><div class="fg"><label class="fl">Warn when budget is % used</label><input type="number" id="thrAmt" min="1" max="99" placeholder="e.g. 80" inputmode="numeric"></div><div class="modal-btns"><button class="mbt cancel" onclick="closeMod('threshModal')">Cancel</button><button class="mbt gold" onclick="saveThresh()">Save</button></div></div></div>

<div class="modal-ov" id="emailModal"><div class="modal-box"><div class="modal-title">Email Address ğŸ“§</div><div class="fg"><label class="fl">Your Email</label><input type="email" id="emailInput" placeholder="e.g. kasun@gmail.com"></div><p style="font-size:11px;color:var(--tx3);margin-bottom:12px;line-height:1.6;font-family:'JetBrains Mono',monospace">Budget alerts will open your mail app with a pre-filled alert email ready to send.</p><div class="modal-btns"><button class="mbt cancel" onclick="closeMod('emailModal')">Cancel</button><button class="mbt gold" onclick="saveEmail()">Save</button></div></div></div>

<div class="toast" id="toast"></div>

<script>
// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘  VAULT LK â€” ENGINE                                   â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ DATA â”€â”€
let D = { txs:[], goals:[], savings:[], investments:[], budgets:{daily:0,weekly:0,monthly:0}, threshold:80,
  user:{ name:'', city:'Colombo', job:'', income:0, goal:'', avatar:'', email:'', emailNotify:true } };

function ld() { try{ const s=localStorage.getItem('vaultlk3'); if(s) D={...D,...JSON.parse(s)}; }catch(e){} }
function sv() { localStorage.setItem('vaultlk3', JSON.stringify(D)); }
ld();

// â”€â”€ CATS â”€â”€
const CATS = {
  income:['ğŸ’¼ Salary','ğŸ’» Freelance','ğŸ“¦ Business','ğŸ“ˆ Returns','ğŸ Gift','ğŸ’° Bonus','ğŸ  Rental Income','ğŸ“Œ Other'],
  expense:['ğŸ› Food & Drink','ğŸšŒ Transport','ğŸ  Housing / Rent','ğŸ’¡ Utilities','ğŸ’Š Health','ğŸ“š Education','ğŸ¬ Entertainment','ğŸ›’ Shopping','ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Family','âœˆï¸ Travel','ğŸ’… Personal Care','ğŸ“Œ Other'],
  saving:['ğŸ¦ Bank Savings','ğŸ›ï¸ Fixed Deposit','ğŸ“… Recurring Deposit','ğŸ”’ Emergency Fund','ğŸ“Œ Other'],
  investment:['ğŸ“Š Unit Trust','ğŸ“ˆ CSE Shares','ğŸ¥‡ Gold','ğŸ  Real Estate','â‚¿ Crypto','ğŸŒ Foreign Stock','ğŸ“Œ Other'],
};
const TPAL=['#f0c040','#1fd47a','#4d9fff','#9d7afa','#ff8c42','#00d4c8','#f472b6','#facc15','#60a5fa','#34d399','#e879f9','#38bdf8'];
const TYPE_C={income:'var(--gr)',expense:'var(--rd)',saving:'var(--bl)',investment:'var(--pu)'};
const TYPE_BG={income:'var(--grx)',expense:'var(--rdx)',saving:'var(--blx)',investment:'var(--pux)'};

// â”€â”€ FORMAT â”€â”€
const rs  = n=>'Rs. '+Math.abs(n).toLocaleString('en-LK',{minimumFractionDigits:2,maximumFractionDigits:2});
const rsK = n=>{ const a=Math.abs(n); return a>=1e6?'Rs.'+(a/1e6).toFixed(2)+'M':a>=1e3?'Rs.'+(a/1e3).toFixed(1)+'K':'Rs.'+a.toFixed(0); };
const today = ()=>new Date().toISOString().split('T')[0];
function startOf(p) {
  const n=new Date();
  if(p==='daily') return new Date(n.getFullYear(),n.getMonth(),n.getDate());
  if(p==='weekly'){const d=new Date(n);d.setDate(d.getDate()-d.getDay());d.setHours(0,0,0,0);return d;}
  if(p==='monthly') return new Date(n.getFullYear(),n.getMonth(),1);
  return new Date(n.getFullYear(),0,1);
}
function inPeriod(tx,p){ return new Date(tx.date+'T00:00:00')>=startOf(p); }
function fmtD(s){ const d=new Date(s+'T00:00:00'); return d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}); }
function greeting(){ const h=new Date().getHours(); return h<12?'Good morning':h<17?'Good afternoon':'Good evening'; }

// â•â• ONBOARDING â•â•
let obStep=0, obBusy=false;
function obNext(){
  if(obBusy)return; obBusy=true; setTimeout(()=>obBusy=false,600);
  // Dismiss keyboard first on iOS
  document.activeElement && document.activeElement.blur();
  if(obStep===0){
    const name=document.getElementById('ob-name').value.trim();
    if(!name){toastM('Please enter your name');obBusy=false;return;}
    D.user.name=name;
    D.user.city=document.getElementById('ob-city').value;
    D.user.email=document.getElementById('ob-email').value.trim();
    const inc=parseFloat(document.getElementById('ob-income')?.value)||0;
    buildPresets(inc);
  }
  if(obStep===1){
    D.user.job=document.getElementById('ob-job').value;
    D.user.income=parseFloat(document.getElementById('ob-income').value)||0;
    D.user.goal=document.getElementById('ob-goal').value;
    buildPresets(D.user.income);
  }
  obStep++; showObStep();
}
function obBack(){ if(obBusy)return; obBusy=true; setTimeout(()=>obBusy=false,400); obStep--; showObStep(); }
function obSkipToLaunch(){
  if(obBusy)return; obBusy=true; setTimeout(()=>obBusy=false,600);
  document.activeElement && document.activeElement.blur();
  const name=document.getElementById('ob-name').value.trim();
  if(!name){toastM('Please enter your name first');obBusy=false;return;}
  D.user.name=name;
  D.user.city=document.getElementById('ob-city').value;
  D.user.email=document.getElementById('ob-email').value.trim();
  if(obStep===1){
    D.user.job=document.getElementById('ob-job').value;
    D.user.income=parseFloat(document.getElementById('ob-income').value)||0;
    D.user.goal=document.getElementById('ob-goal').value;
  }
  sv(); launchApp();
}
function obFinish(){
  if(obBusy)return; obBusy=true; setTimeout(()=>obBusy=false,600);
  document.activeElement && document.activeElement.blur();
  const m=parseFloat(document.getElementById('ob-monthly').value)||0;
  const d=parseFloat(document.getElementById('ob-daily').value)||0;
  D.budgets.monthly=m; D.budgets.daily=d;
  if(m>0) D.budgets.weekly=Math.round(m/4.33/1000)*1000;
  sv(); launchApp();
}
function buildPresets(inc){
  const presets=inc>0?[
    {l:'Conservative (50%)',m:Math.round(inc*.5/1000)*1000,d:Math.round(inc*.5/30/100)*100},
    {l:'Moderate (65%)',m:Math.round(inc*.65/1000)*1000,d:Math.round(inc*.65/30/100)*100},
    {l:'Flexible (80%)',m:Math.round(inc*.8/1000)*1000,d:Math.round(inc*.8/30/100)*100},
    {l:'Custom',m:0,d:0},
  ]:[
    {l:'Tight (Rs.40K)',m:40000,d:1300},{l:'Moderate (Rs.60K)',m:60000,d:2000},
    {l:'Comfortable (Rs.90K)',m:90000,d:3000},{l:'Custom',m:0,d:0},
  ];
  const el=document.getElementById('ob-presets');
  el.innerHTML=presets.map((p,i)=>`<div class="bp-btn" onclick="applyPreset(${p.m},${p.d},${i})">${p.l}${p.m?'<br><span style="font-size:9px;color:var(--tx3)">Rs.'+p.m.toLocaleString()+'/mo</span>':''}</div>`).join('');
}
function applyPreset(m,d,i){
  document.querySelectorAll('.bp-btn').forEach((x,j)=>x.classList.toggle('on',j===i));
  if(m){ document.getElementById('ob-monthly').value=m; document.getElementById('ob-daily').value=d; }
}
function handleAvatarUpload(inp){
  const f=inp.files[0]; if(!f)return;
  const r=new FileReader();
  r.onload=e=>{
    D.user.avatar=e.target.result;
    const img=document.getElementById('avatarPreview');
    img.src=e.target.result; img.style.display='block';
    document.querySelector('.ap-icon').style.display='none';
  };
  r.readAsDataURL(f);
}

// â•â• LAUNCH APP â•â•
function launchApp(){
  document.getElementById('onboarding').style.display='none';
  document.getElementById('app').classList.remove('hidden');
  go('home');
  setTimeout(()=>{ addChatMsg('ai',`ğŸ‘‹ Hello ${D.user.name}! I'm Vault AI, your personal finance assistant. I can see your transactions, goals, and budgets in real time. Ask me anything â€” like "How am I doing this month?" or "How can I reach my BMW goal faster?" ğŸš—`); },800);
}

// â•â• NAVIGATION â•â•
let curPage='home', curFT='income', curTxF='all', curRP='monthly', pendingDelId=null, pendingGoalId=null, pendingBudPeriod=null;
function go(p){
  curPage=p;
  document.querySelectorAll('.pg').forEach(x=>x.classList.remove('on'));
  document.querySelectorAll('.nb').forEach(x=>x.classList.remove('on'));
  document.getElementById('pg-'+p).classList.add('on');
  const nb=document.getElementById('nb-'+p); if(nb) nb.classList.add('on');
  renderPage(p);
}
function renderPage(p){
  if(p==='home') renderHome();
  else if(p==='txns') renderTxns();
  else if(p==='add') initAdd();
  else if(p==='goals') renderGoals();
  else if(p==='profile') renderProfile();
}

// â•â• HOME â•â•
function renderHome(){
  const inc=D.txs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  const exp=D.txs.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
  const savTx=D.txs.filter(t=>t.type==='saving').reduce((s,t)=>s+t.amount,0);
  const invTx=D.txs.filter(t=>t.type==='investment').reduce((s,t)=>s+t.amount,0);
  const savBal=D.savings.reduce((s,a)=>s+a.balance,0)+savTx;
  const invBal=D.investments.reduce((s,i)=>s+i.currentValue,0)+invTx;
  const nw=inc-exp+savBal+invBal;

  // Avatar
  const ha=document.getElementById('heroAvatar');
  if(D.user.avatar){ ha.innerHTML=`<img src="${D.user.avatar}" alt="avatar">`; }
  else { ha.innerHTML='ğŸ˜Š'; ha.style.background='var(--s3)'; }
  document.getElementById('heroUsername').textContent=`${greeting()},`;
  document.getElementById('heroGreeting').textContent=D.user.name||'Friend';

  const nwEl=document.getElementById('heroNW');
  nwEl.className='hero-bal '+(nw>0?'pos':nw<0?'neg':'zer');
  document.getElementById('heroNWAmt').textContent=Math.abs(nw).toLocaleString('en-LK',{minimumFractionDigits:2,maximumFractionDigits:2});

  document.getElementById('heroStats').innerHTML=`
    <div class="hst"><div class="hst-l">INCOME</div><div class="hst-v" style="color:var(--gr)">${rsK(inc)}</div></div>
    <div class="hst"><div class="hst-l">SPENT</div><div class="hst-v" style="color:var(--rd)">${rsK(exp)}</div></div>
    <div class="hst"><div class="hst-l">SAVINGS</div><div class="hst-v" style="color:var(--bl)">${rsK(savBal)}</div></div>
    <div class="hst"><div class="hst-l">INVESTED</div><div class="hst-v" style="color:var(--pu)">${rsK(invBal)}</div></div>
  `;

  // Monthly quick row
  const mInc=D.txs.filter(t=>t.type==='income'&&inPeriod(t,'monthly')).reduce((s,t)=>s+t.amount,0);
  const mExp=D.txs.filter(t=>t.type==='expense'&&inPeriod(t,'monthly')).reduce((s,t)=>s+t.amount,0);
  const mSav=D.txs.filter(t=>t.type==='saving'&&inPeriod(t,'monthly')).reduce((s,t)=>s+t.amount,0);
  document.getElementById('quickRow').innerHTML=`
    <div style="background:var(--s1);border:1px solid var(--ln);border-radius:var(--r2);padding:13px;text-align:center"><div style="font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--tx3);margin-bottom:4px">THIS MONTH</div><div style="font-size:16px;font-weight:800;color:var(--gr)">${rsK(mInc)}</div></div>
    <div style="background:var(--s1);border:1px solid var(--ln);border-radius:var(--r2);padding:13px;text-align:center"><div style="font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--tx3);margin-bottom:4px">SPENT</div><div style="font-size:16px;font-weight:800;color:var(--rd)">${rsK(mExp)}</div></div>
    <div style="background:var(--s1);border:1px solid var(--ln);border-radius:var(--r2);padding:13px;text-align:center"><div style="font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--tx3);margin-bottom:4px">SAVED</div><div style="font-size:16px;font-weight:800;color:var(--bl)">${rsK(mSav)}</div></div>
  `;

  // Budget bars
  let bHtml='';
  if(D.budgets.monthly>0) bHtml+=bbarHTML('Monthly',mExp,D.budgets.monthly);
  const dExp=D.txs.filter(t=>t.type==='expense'&&inPeriod(t,'daily')).reduce((s,t)=>s+t.amount,0);
  if(D.budgets.daily>0) bHtml+=bbarHTML('Daily',dExp,D.budgets.daily);
  document.getElementById('budgetSection').innerHTML=bHtml?`<div class="card">${bHtml}</div>`:'';

  // Alerts
  renderAlerts(mExp,mInc,dExp);

  // Recent
  const recent=[...D.txs].reverse().slice(0,5);
  document.getElementById('recentList').innerHTML=recent.length?recent.map(t=>txiHTML(t)).join(''):'<div class="empty"><span class="em">ğŸ“’</span>No entries yet.<br>Tap ï¼‹ to start.</div>';
}

function bbarHTML(label,spent,budget){
  const p=Math.min((spent/budget)*100,100);
  const cls=p>=100?'d':p>=D.threshold?'w':'s';
  const col=p>=100?'var(--rd)':p>=D.threshold?'var(--gd)':'var(--gr)';
  return `<div class="bbar"><div class="bbar-hd"><span class="bbar-l">${label} Budget</span><span class="bbar-p" style="color:${col}">${p.toFixed(0)}%</span></div><div class="bbar-track"><div class="bbar-fill ${cls}" style="width:${p}%"></div></div><div class="bbar-sub"><span>Spent: ${rsK(spent)}</span><span>Limit: ${rsK(budget)}</span></div></div>`;
}

function renderAlerts(mExp,mInc,dExp){
  const al=[];
  const {monthly:mb,daily:db}=D.budgets;
  if(mb>0){
    const p=(mExp/mb)*100;
    if(p>=100){
      al.push({t:'d',i:'ğŸš¨',ttl:'Monthly Budget Exceeded!',m:`Spent ${rs(mExp)} â€” Rs.${(mExp-mb).toLocaleString()} over your limit.`});
      // Fire email alert (throttled by localStorage flag per day)
      const flagKey='vlt_malert_'+new Date().toDateString();
      if(!localStorage.getItem(flagKey)){localStorage.setItem(flagKey,'1');triggerBudgetAlert('Monthly',mExp,mb);}
    }
    else if(p>=D.threshold) al.push({t:'w',i:'âš ï¸',ttl:`${p.toFixed(0)}% of Monthly Budget Used`,m:`Only Rs.${(mb-mExp).toLocaleString()} remaining.`});
  }
  if(db>0&&dExp>db){
    al.push({t:'d',i:'ğŸ“…',ttl:'Daily Budget Exceeded',m:`Spent ${rs(dExp)} today vs limit of ${rs(db)}.`});
    const flagKey='vlt_dalert_'+new Date().toDateString();
    if(!localStorage.getItem(flagKey)){localStorage.setItem(flagKey,'1');triggerBudgetAlert('Daily',dExp,db);}
  }
  if(mInc>0){const sr=((mInc-mExp)/mInc)*100; if(sr>=25) al.push({t:'g',i:'ğŸ†',ttl:`Great! ${sr.toFixed(0)}% Savings Rate`,m:'You are saving more than 25% of income this month.'});}
  D.goals.forEach(g=>{const p=(g.saved/g.target)*100; if(p>=90&&p<100) al.push({t:'i',i:'ğŸ¯',ttl:`"${g.name}" almost done!`,m:`${p.toFixed(0)}% complete. Only Rs.${(g.target-g.saved).toLocaleString()} left!`});});
  document.getElementById('alertArea').innerHTML=al.map(a=>`<div class="alert ${a.t}"><span class="alert-i">${a.i}</span><div><div class="alert-t">${a.ttl}</div><div class="alert-m">${a.m}</div></div></div>`).join('');
}

// â•â• TX HTML â•â•
function txiHTML(tx,del=true){
  const emoji=(tx.category||' ').split(' ')[0];
  const col=TYPE_C[tx.type]||'var(--tx)';
  const bg=TYPE_BG[tx.type]||'rgba(255,255,255,.04)';
  const sign=tx.type==='income'||tx.type==='saving'||tx.type==='investment'?'+':'âˆ’';
  return `<div class="txi">
    <div class="txi-ico" style="background:${bg}">${emoji}</div>
    <div class="txi-body"><div class="txi-name">${tx.desc}</div><div class="txi-meta">${fmtD(tx.date)} Â· <span style="color:${col};font-weight:700;font-size:9px;text-transform:uppercase;letter-spacing:.5px">${tx.type}</span></div></div>
    <div class="txi-r">
      <div class="txi-amt" style="color:${col}">${sign}${rsK(tx.amount)}</div>
      <div class="txi-sub">${(tx.category||'').replace(/^.\s/,'').slice(0,12)}</div>
      ${del?`<button class="del-b" onclick="openDel('${tx.id}')">âœ•</button>`:''}
    </div>
  </div>`;
}

// â•â• TX LIST â•â•
function renderTxns(){
  let list=[...D.txs].reverse();
  if(curTxF!=='all') list=list.filter(t=>t.type===curTxF);
  const el=document.getElementById('fullTxList');
  if(!list.length){el.innerHTML='<div class="empty"><span class="em">ğŸ“­</span>No entries.</div>';return;}
  const g={};
  list.forEach(tx=>{const k=fmtD(tx.date);if(!g[k])g[k]=[];g[k].push(tx);});
  el.innerHTML=Object.entries(g).map(([d,items])=>`<div class="txg-h">${d}</div>${items.map(txiHTML).join('')}`).join('');
}
function setTxF(f,btn){curTxF=f;document.querySelectorAll('#txFilterTabs .stab').forEach(x=>x.classList.remove('on'));btn.classList.add('on');renderTxns();}

// â•â• ADD ENTRY â•â•
function initAdd(){
  document.getElementById('fDate').valueAsDate=new Date();
  populateCats();
}
function setFT(t){
  curFT=t;
  ['income','expense','saving','investment'].forEach(x=>{
    const b=document.getElementById('tt-'+x);
    b.classList.toggle('on',x===t);
  });
  populateCats();
}
function populateCats(){
  document.getElementById('fCat').innerHTML=(CATS[curFT]||[]).map(c=>`<option value="${c}">${c}</option>`).join('');
}
function addTx(){
  const amt=parseFloat(document.getElementById('fAmt').value);
  const desc=document.getElementById('fDesc').value.trim();
  const cat=document.getElementById('fCat').value;
  const date=document.getElementById('fDate').value;
  const note=document.getElementById('fNote').value.trim();
  if(!amt||amt<=0){toastM('Enter a valid amount');return;}
  if(!desc){toastM('Enter a description');return;}
  if(!date){toastM('Select a date');return;}
  D.txs.push({id:Date.now().toString(36)+Math.random().toString(36).slice(2),type:curFT,amount:amt,desc,category:cat,date,note});
  sv();
  toastM(curFT==='income'?'âœ“ Income added!':curFT==='expense'?'âœ“ Expense recorded!':curFT==='saving'?'âœ“ Saving logged!':'âœ“ Investment recorded!');
  document.getElementById('fAmt').value='';
  document.getElementById('fDesc').value='';
  document.getElementById('fNote').value='';
  document.getElementById('fDate').valueAsDate=new Date();
  setTimeout(()=>go('home'),400);
}

// â•â• GOALS â•â•
function renderGoals(){
  const el=document.getElementById('goalsList');
  if(!D.goals.length){el.innerHTML='<div class="empty"><span class="em">ğŸ¯</span>No goals yet.<br>Tap ï¼‹ New to create one.</div>';return;}
  el.innerHTML=D.goals.map(g=>{
    const p=Math.min((g.saved/g.target)*100,100);
    const rem=Math.max(0,g.target-g.saved);
    const mos=g.monthly>0?Math.ceil(rem/g.monthly):null;
    const yr=mos?Math.floor(mos/12):null;
    const etaTxt=mos?(yr>0?`${yr}y ${mos%12}m`:`${mos} months`)+` at ${rsK(g.monthly)}/mo`:'Set monthly contribution';
    return `<div class="goal-card">
      <button class="goal-del" onclick="delGoal('${g.id}')">âœ•</button>
      <div style="font-size:30px;margin-bottom:10px">${g.emoji||'ğŸ¯'}</div>
      <div style="font-size:17px;font-weight:800;margin-bottom:3px">${g.name}</div>
      <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--tx2);margin-bottom:12px">Target: ${rs(g.target)}</div>
      <div class="goal-bar"><div class="goal-fill" style="width:${p}%;background:${g.color}"></div></div>
      <div style="display:flex;justify-content:space-between;align-items:flex-end">
        <div><div style="font-family:'Clash Display',sans-serif;font-size:24px;font-weight:700;color:${g.color}">${p.toFixed(1)}%</div><div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--tx3);margin-top:2px">Saved: ${rsK(g.saved)}</div></div>
        <div style="text-align:right"><div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--tx2);line-height:1.6">${etaTxt}</div><div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:${g.color};margin-top:2px">Need: ${rsK(rem)}</div></div>
      </div>
      ${p>=100
        ?'<div style="margin-top:12px;padding:10px;background:var(--grx);border-radius:var(--r2);text-align:center;color:var(--gr);font-weight:800;font-size:14px">ğŸ‰ GOAL ACHIEVED!</div>'
        :`<button class="goal-af-btn" onclick="openFundMod('${g.id}')">ï¼‹ Add Funds</button>`}
    </div>`;
  }).join('');
}
function openGoalModal(){['gName','gTarget','gSaved','gMonthly','gEmoji'].forEach(id=>document.getElementById(id).value='');document.getElementById('gEmoji').value='ğŸ¯';openMod('goalModal');}
function saveGoal(){
  const name=document.getElementById('gName').value.trim();
  const target=parseFloat(document.getElementById('gTarget').value);
  const saved=parseFloat(document.getElementById('gSaved').value)||0;
  const monthly=parseFloat(document.getElementById('gMonthly').value)||0;
  const emoji=document.getElementById('gEmoji').value||'ğŸ¯';
  const color=document.getElementById('gColor').value;
  if(!name){toastM('Enter goal name');return;}
  if(!target||target<=0){toastM('Enter target amount');return;}
  D.goals.push({id:Date.now().toString(36),name,target,saved,monthly,emoji,color,created:today()});
  sv();closeMod('goalModal');renderGoals();toastM('ğŸ¯ Goal created!');
}
function openFundMod(id){pendingGoalId=id;document.getElementById('gfAmt').value='';openMod('fundModal');}
function fundGoal(){
  const amt=parseFloat(document.getElementById('gfAmt').value);
  if(!amt||amt<=0){toastM('Enter amount');return;}
  const g=D.goals.find(x=>x.id===pendingGoalId);
  if(g){g.saved+=amt;sv();closeMod('fundModal');renderGoals();toastM('ğŸ’° Funds added!');}
}
function delGoal(id){D.goals=D.goals.filter(g=>g.id!==id);sv();renderGoals();toastM('Goal removed');}

// â•â• PROFILE â•â•
function renderProfile(){
  // Avatar
  const pa=document.getElementById('pfAvatar');
  if(D.user.avatar) pa.innerHTML=`<img src="${D.user.avatar}" alt="avatar">`;
  else pa.innerHTML='ğŸ˜Š';
  document.getElementById('pfName').textContent=D.user.name||'â€”';
  document.getElementById('pfSub').textContent=`${D.user.job||'â€”'} Â· ${D.user.city}`;

  const inc=D.txs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  const exp=D.txs.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
  const savRate=inc>0?(((inc-exp)/inc)*100).toFixed(0):0;
  let badge='ğŸŒŸ Vault Member';
  if(savRate>=30) badge='ğŸ’ Super Saver';
  else if(savRate>=20) badge='ğŸ¥‡ Smart Saver';
  else if(D.txs.length>=20) badge='ğŸ“Š Active Tracker';
  document.getElementById('pfBadge').textContent=badge;

  document.getElementById('pfStats').innerHTML=`
    <div class="stat-box"><div class="stat-box-l">ENTRIES</div><div class="stat-box-v" style="color:var(--gd)">${D.txs.length}</div></div>
    <div class="stat-box"><div class="stat-box-l">GOALS</div><div class="stat-box-v" style="color:var(--pu)">${D.goals.length}</div></div>
    <div class="stat-box"><div class="stat-box-l">SAVE RATE</div><div class="stat-box-v" style="color:var(--gr)">${savRate}%</div></div>
  `;

  // Email settings display
  const emailSub=document.getElementById('set-email-sub');
  if(emailSub) emailSub.textContent=D.user.email||'Not set';
  updateEmailToggleUI();
  updateScheduleToggleUI();

  // Savings accounts
  const sl=document.getElementById('savAccountsList');
  sl.innerHTML=D.savings.length?D.savings.map(a=>`
    <div class="sav-item">
      <div><div class="sav-item-l">ğŸ¦ ${a.name}</div><div class="sav-item-s">${a.rate}% annual interest</div></div>
      <div style="text-align:right"><div class="sav-item-v">${rsK(a.balance)}</div><button onclick="delSav('${a.id}')" style="background:none;border:none;color:var(--tx3);font-size:11px;cursor:pointer;margin-top:4px;font-family:'Satoshi',sans-serif">Remove</button></div>
    </div>`).join(''):'<div style="font-size:12px;color:var(--tx3);padding:8px 0">No savings accounts yet.</div>';

  // Investments
  const il=document.getElementById('investList');
  il.innerHTML=D.investments.length?D.investments.map(inv=>{
    const ret=inv.currentValue-inv.cost;
    const retP=inv.cost>0?((ret/inv.cost)*100).toFixed(1):0;
    return `<div class="inv-card">
      <div class="inv-ico">ğŸ“Š</div>
      <div class="inv-body"><div class="inv-name">${inv.name}</div><div class="inv-type">${inv.type}</div></div>
      <div class="inv-right">
        <div class="inv-val">${rsK(inv.currentValue)}</div>
        <div class="inv-ret ${ret>=0?'up':'dn'}">${ret>=0?'+':''}${retP}%</div>
        <button onclick="delInv('${inv.id}')" style="background:none;border:none;color:var(--tx3);font-size:11px;cursor:pointer;margin-top:3px;font-family:'Satoshi',sans-serif">Remove</button>
      </div>
    </div>`;
  }).join(''):'<div style="font-size:12px;color:var(--tx3);padding:8px 0">No investments yet.</div>';

  // Budget settings
  document.getElementById('set-monthly-sub').textContent=D.budgets.monthly?rsK(D.budgets.monthly):'Not set';
  document.getElementById('set-weekly-sub').textContent=D.budgets.weekly?rsK(D.budgets.weekly):'Not set';
  document.getElementById('set-daily-sub').textContent=D.budgets.daily?rsK(D.budgets.daily):'Not set';
  document.getElementById('set-thresh').textContent=D.threshold+'%';

  // Reports
  renderReports();
}

function handleProfilePhoto(inp){
  const f=inp.files[0]; if(!f)return;
  const r=new FileReader();
  r.onload=e=>{
    D.user.avatar=e.target.result;
    sv();
    const pa=document.getElementById('pfAvatar');
    if(pa) pa.innerHTML=`<img src="${D.user.avatar}" alt="avatar" style="width:100%;height:100%;border-radius:50%;object-fit:cover;display:block">`;
    toastM('âœ… Profile photo updated!');
    // reset input so same file can be picked again
    inp.value='';
  };
  r.readAsDataURL(f);
}

// â•â• REPORTS â•â•
function setRP(p,btn){curRP=p;document.querySelectorAll('#reportTabs .stab').forEach(x=>x.classList.remove('on'));btn.classList.add('on');renderReports();}
function renderReports(){
  const txs=D.txs.filter(t=>inPeriod(t,curRP));
  const inc=txs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  const exp=txs.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
  const sav=txs.filter(t=>t.type==='saving').reduce((s,t)=>s+t.amount,0);
  const inv=txs.filter(t=>t.type==='investment').reduce((s,t)=>s+t.amount,0);
  const net=inc-exp;
  const bycat={};
  txs.filter(t=>t.type==='expense').forEach(t=>{bycat[t.category]=(bycat[t.category]||0)+t.amount;});
  const catArr=Object.entries(bycat).sort((a,b)=>b[1]-a[1]);
  const trend=buildTrend(14);
  const rc=document.getElementById('reportContent');
  if(!rc)return;
  rc.innerHTML=`
    <div class="r-grid">
      <div class="rbox"><div class="rbox-l">INCOME</div><div class="rbox-v g">${rsK(inc)}</div></div>
      <div class="rbox"><div class="rbox-l">EXPENSES</div><div class="rbox-v r">${rsK(exp)}</div></div>
      <div class="rbox"><div class="rbox-l">SAVINGS</div><div class="rbox-v b">${rsK(sav)}</div></div>
      <div class="rbox"><div class="rbox-l">INVESTED</div><div class="rbox-v p">${rsK(inv)}</div></div>
      <div class="rbox"><div class="rbox-l">NET</div><div class="rbox-v ${net>=0?'g':'r'}">${net>=0?'+':'âˆ’'}${rsK(Math.abs(net))}</div></div>
      <div class="rbox"><div class="rbox-l">SAVE RATE</div><div class="rbox-v go">${inc>0?((sav/inc)*100).toFixed(0):0}%</div></div>
    </div>
    <div class="sec-lbl" style="margin-top:4px">14-Day Trend</div>
    <div class="card" style="padding:14px">${buildLineChart(trend)}</div>
    <div class="sec-lbl" style="margin-top:4px">Spending Breakdown</div>
    <div class="card" style="padding:14px">${catArr.length?buildDonut(catArr,exp):'<div style="font-size:12px;color:var(--tx3)">No expense data.</div>'}</div>
    <div class="sec-lbl" style="margin-top:4px">Category Bars</div>
    <div class="card" style="padding:14px">${buildCatBars(catArr,exp)}</div>
    <div class="sec-lbl" style="margin-top:4px">ğŸ’¡ Smart Suggestions</div>
    ${buildSuggs(inc,exp,sav,inv,catArr)}
  `;
}

function buildTrend(days){
  const arr=[];
  for(let i=days-1;i>=0;i--){
    const d=new Date(); d.setDate(d.getDate()-i);
    const ds=d.toISOString().split('T')[0];
    const inc=D.txs.filter(t=>t.type==='income'&&t.date===ds).reduce((s,t)=>s+t.amount,0);
    const exp=D.txs.filter(t=>t.type==='expense'&&t.date===ds).reduce((s,t)=>s+t.amount,0);
    arr.push({ds,lbl:d.toLocaleDateString('en-US',{month:'short',day:'numeric'}),inc,exp});
  }
  return arr;
}
function buildLineChart(data){
  const W=320,H=110,pd={t:8,r:8,b:28,l:44};
  const iW=W-pd.l-pd.r,iH=H-pd.t-pd.b;
  const maxV=Math.max(...data.map(d=>Math.max(d.inc,d.exp)),1);
  const xS=iW/(data.length-1||1);
  const yS=v=>iH-(v/maxV)*iH;
  const ip=data.map((d,i)=>`${i===0?'M':'L'}${pd.l+i*xS},${pd.t+yS(d.inc)}`).join(' ');
  const ep=data.map((d,i)=>`${i===0?'M':'L'}${pd.l+i*xS},${pd.t+yS(d.exp)}`).join(' ');
  const ia=ip+` L${pd.l+(data.length-1)*xS},${pd.t+iH} L${pd.l},${pd.t+iH} Z`;
  const ea=ep+` L${pd.l+(data.length-1)*xS},${pd.t+iH} L${pd.l},${pd.t+iH} Z`;
  const yl=[0,.5,1].map(f=>{const v=maxV*f,y=pd.t+yS(v);return `<text x="${pd.l-5}" y="${y+4}" text-anchor="end" font-size="8" fill="#3d5070">${v>=1000?(v/1000).toFixed(0)+'K':v.toFixed(0)}</text>`;}).join('');
  const xl=data.filter((_,i)=>i%3===0).map((d,i)=>{const idx=data.indexOf(d);return `<text x="${pd.l+idx*xS}" y="${H-2}" text-anchor="middle" font-size="8" fill="#3d5070">${d.lbl}</text>`;}).join('');
  return `<svg viewBox="0 0 ${W} ${H}" width="100%" style="overflow:visible;display:block">
    <defs>
      <linearGradient id="g1" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#1fd47a" stop-opacity=".2"/><stop offset="100%" stop-color="#1fd47a" stop-opacity="0"/></linearGradient>
      <linearGradient id="g2" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#ff4466" stop-opacity=".2"/><stop offset="100%" stop-color="#ff4466" stop-opacity="0"/></linearGradient>
    </defs>
    <path d="${ia}" fill="url(#g1)"/>
    <path d="${ea}" fill="url(#g2)"/>
    <path d="${ip}" fill="none" stroke="#1fd47a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="${ep}" fill="none" stroke="#ff4466" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    ${yl}${xl}
    <rect x="${W-50}" y="4" width="8" height="8" rx="2" fill="#1fd47a"/>
    <text x="${W-38}" y="12" font-size="9" fill="#8fa3c8">Income</text>
    <rect x="${W-50}" y="18" width="8" height="8" rx="2" fill="#ff4466"/>
    <text x="${W-38}" y="26" font-size="9" fill="#8fa3c8">Expense</text>
  </svg>`;
}
function buildDonut(catArr,total){
  if(!total)return'';
  const R=55,cx=70,cy=68,sw=18;
  let angle=-Math.PI/2, paths='';
  catArr.slice(0,8).forEach(([cat,amt],i)=>{
    const sweep=(amt/total)*2*Math.PI;
    const x1=cx+R*Math.cos(angle),y1=cy+R*Math.sin(angle);
    const x2=cx+R*Math.cos(angle+sweep),y2=cy+R*Math.sin(angle+sweep);
    const lg=sweep>Math.PI?1:0;
    paths+=`<path d="M${cx},${cy} L${x1},${y1} A${R},${R} 0 ${lg},1 ${x2},${y2} Z" fill="${TPAL[i%TPAL.length]}" opacity=".85"/>`;
    angle+=sweep;
  });
  const leg=catArr.slice(0,6).map(([cat,amt],i)=>`<div class="dl-row"><div class="dl-dot" style="background:${TPAL[i%TPAL.length]}"></div><div class="dl-name">${(cat||'').replace(/^.\s/,'').slice(0,14)}</div><div class="dl-val">${((amt/total)*100).toFixed(0)}%</div></div>`).join('');
  return `<div class="donut-wrap"><svg viewBox="0 0 140 136" width="140" style="flex-shrink:0">${paths}<circle cx="${cx}" cy="${cy}" r="${R-sw}" fill="var(--s1)"/><text x="${cx}" y="${cy-5}" text-anchor="middle" font-size="9" fill="#8fa3c8">TOTAL</text><text x="${cx}" y="${cy+10}" text-anchor="middle" font-size="10" fill="#eef2ff" font-weight="bold">${rsK(total)}</text></svg><div class="donut-leg">${leg}</div></div>`;
}
function buildCatBars(catArr,total){
  if(!catArr.length)return'<div style="font-size:12px;color:var(--tx3)">No data.</div>';
  return catArr.slice(0,6).map(([cat,amt],i)=>{
    const p=total>0?(amt/total*100):0;
    return `<div style="margin-bottom:10px"><div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="font-size:12px;font-weight:700">${(cat||' ').split(' ')[0]} ${(cat||'').replace(/^.\s/,'').slice(0,16)}</span><span style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--tx2)">${rsK(amt)} Â· ${p.toFixed(0)}%</span></div><div style="height:7px;background:rgba(255,255,255,.04);border-radius:4px;overflow:hidden"><div style="width:${p}%;height:100%;background:${TPAL[i%TPAL.length]};border-radius:4px;transition:width .6s"></div></div></div>`;
  }).join('');
}
function buildSuggs(inc,exp,sav,inv,catArr){
  const S=[];
  const sr=inc>0?((sav/inc)*100):0;
  const ir=inc>0?((inv/inc)*100):0;
  const top=catArr[0];
  if(inc===0) S.push({i:'ğŸ“',t:'Start Tracking',d:'Add your first income entry to unlock smart suggestions.'});
  if(inc>0&&sr<10) S.push({i:'ğŸ¦',t:'Increase Savings',d:`You saved ${sr.toFixed(0)}% of income. Sri Lanka economists recommend 20%+ to build financial security.`});
  if(inc>0&&sr>=20) S.push({i:'ğŸ†',t:'Excellent Savings Rate!',d:`${sr.toFixed(0)}% savings rate! Consider NSB or Sampath fixed deposits for guaranteed returns.`});
  if(inc>0&&ir<5) S.push({i:'ğŸ“ˆ',t:'Start Investing',d:'Investing even Rs.5,000/month in a unit trust can grow significantly over 5 years at 12% returns.'});
  if(top&&exp>0&&(top[1]/exp)>.4) S.push({i:'ğŸ”',t:`High ${(top[0]||'').replace(/^.\s/,'').slice(0,12)} Spend`,d:`${((top[1]/exp)*100).toFixed(0)}% of expenses in this category. Try setting a sub-limit.`});
  D.goals.forEach(g=>{const rem=Math.max(0,g.target-g.saved);if(rem>0&&g.monthly>0&&inc>0&&(g.monthly/inc)>.35) S.push({i:'âš ï¸',t:`Goal "${g.name}" needs ${((g.monthly/inc)*100).toFixed(0)}% of income`,d:'Consider extending the target date or increasing income streams.'});});
  const invProfit=D.investments.reduce((s,i)=>s+(i.currentValue-i.cost),0);
  if(invProfit>0) S.push({i:'ğŸ“Š',t:`Portfolio +${rsK(invProfit)} in profit!`,d:`Your investments are performing well. Consider reinvesting profits into diversified assets.`});
  if(!S.length) S.push({i:'âœ¨',t:"You're on Track!",d:'Keep logging entries regularly. Consistency is the key to financial success.'});
  return S.map(s=>`<div class="sugg-item"><span class="sugg-ico">${s.i}</span><div><div class="sugg-t">${s.t}</div><div class="sugg-d">${s.d}</div></div></div>`).join('');
}

// â•â• SAVINGS & INVESTMENTS â•â•
function openSavModal(){['saName','saBal','saRate'].forEach(id=>document.getElementById(id).value='');openMod('savModal');}
function saveSavAcc(){
  const name=document.getElementById('saName').value.trim();
  const bal=parseFloat(document.getElementById('saBal').value)||0;
  const rate=parseFloat(document.getElementById('saRate').value)||0;
  if(!name){toastM('Enter account name');return;}
  D.savings.push({id:Date.now().toString(36),name,balance:bal,rate});sv();closeMod('savModal');renderProfile();toastM('Account added!');
}
function delSav(id){D.savings=D.savings.filter(s=>s.id!==id);sv();renderProfile();toastM('Removed');}
function openInvModal(){['invName','invCost','invVal'].forEach(id=>document.getElementById(id).value='');openMod('invModal');}
function saveInv(){
  const name=document.getElementById('invName').value.trim();
  const type=document.getElementById('invType').value;
  const cost=parseFloat(document.getElementById('invCost').value)||0;
  const currentValue=parseFloat(document.getElementById('invVal').value)||0;
  if(!name){toastM('Enter name');return;}
  D.investments.push({id:Date.now().toString(36),name,type,cost,currentValue});sv();closeMod('invModal');renderProfile();toastM('Investment added!');
}
function delInv(id){D.investments=D.investments.filter(i=>i.id!==id);sv();renderProfile();toastM('Removed');}

// â•â• BUDGET MODAL â•â•
function openBudgetModal(period){
  pendingBudPeriod=period;
  document.getElementById('budgetModalTitle').textContent=`Set ${period.charAt(0).toUpperCase()+period.slice(1)} Budget`;
  document.getElementById('budgetModalLbl').textContent=`${period.charAt(0).toUpperCase()+period.slice(1)} spending limit (Rs.)`;
  document.getElementById('bAmt').value=D.budgets[period]||'';
  openMod('budgetModal');
}
function saveBudget(){const v=parseFloat(document.getElementById('bAmt').value);if(!v||v<=0){toastM('Enter valid amount');return;}D.budgets[pendingBudPeriod]=v;sv();closeMod('budgetModal');renderProfile();toastM('Budget saved!');}
function openThreshModal(){document.getElementById('thrAmt').value=D.threshold;openMod('threshModal');}
function saveThresh(){const v=parseInt(document.getElementById('thrAmt').value);if(!v||v<1||v>99){toastM('Enter 1â€“99');return;}D.threshold=v;sv();closeMod('threshModal');renderProfile();toastM('Threshold saved!');}

// â•â• DELETE â•â•
function openDel(id){pendingDelId=id;openMod('deleteModal');}
function confirmDelete(){if(pendingDelId){D.txs=D.txs.filter(t=>t.id!==pendingDelId);sv();closeMod('deleteModal');toastM('Deleted');renderPage(curPage);}}

// â•â• MODALS â•â•
function openMod(id){document.getElementById(id).classList.add('on');}
function closeMod(id){document.getElementById(id).classList.remove('on');}
document.querySelectorAll('.modal-ov').forEach(m=>{m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('on');});});

// â•â• CLEAR â•â•
function confirmClear(){if(confirm('Delete ALL data? This cannot be undone.')){ D={txs:[],goals:[],savings:[],investments:[],budgets:{daily:0,weekly:0,monthly:0},threshold:80,user:{name:'',city:'',job:'',income:0,goal:'',avatar:''}};sv();document.getElementById('onboarding').style.removeProperty('display');document.getElementById('app').classList.add('hidden');obStep=0;showObStep();toastM('Data cleared');}}

// â•â• DOWNLOADS â•â•
function downloadCSV(){
  const rows=[['Date','Type','Description','Category','Amount (Rs.)','Note']];
  D.txs.forEach(t=>rows.push([t.date,t.type,t.desc,t.category||'',t.amount.toFixed(2),t.note||'']));
  const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob(['\ufeff'+csv],{type:'text/csv;charset=utf-8'}));a.download=`VaultLK_${today()}.csv`;a.click();toastM('ğŸ“¥ CSV downloaded!');
}
function downloadPDF(){
  const txs=D.txs.filter(t=>inPeriod(t,curRP));
  const inc=txs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  const exp=txs.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
  const sav=txs.filter(t=>t.type==='saving').reduce((s,t)=>s+t.amount,0);
  const inv=txs.filter(t=>t.type==='investment').reduce((s,t)=>s+t.amount,0);
  const label={daily:'Today',weekly:'This Week',monthly:'This Month',annually:'This Year'}[curRP];
  const bycat={};txs.filter(t=>t.type==='expense').forEach(t=>{bycat[t.category]=(bycat[t.category]||0)+t.amount;});
  const w=window.open('','_blank');
  w.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Vault LK Report â€” ${label}</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:system-ui,sans-serif;color:#111;background:#fff;padding:36px}h1{font-size:30px;font-weight:900;color:#06080f;letter-spacing:-1px;margin-bottom:3px}h2{font-size:16px;font-weight:700;margin:22px 0 10px;color:#333}.sub{color:#777;font-size:12px;margin-bottom:24px}.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:24px}.box{background:#f7f8ff;border:1px solid #e2e5f0;border-radius:10px;padding:14px}.box-l{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:#999;margin-bottom:3px}.box-v{font-size:20px;font-weight:800}.g{color:#1a6640}.r{color:#cc1133}.b{color:#1155cc}.p{color:#5511aa}table{width:100%;border-collapse:collapse}th{background:#06080f;color:#fff;padding:9px 11px;text-align:left;font-size:11px;letter-spacing:.8px;text-transform:uppercase}td{padding:8px 11px;border-bottom:1px solid #eee;font-size:12px}tr:nth-child(even) td{background:#fafafa}.ti{color:#1a6640;font-weight:700}.te{color:#cc1133;font-weight:700}.ts{color:#1155cc;font-weight:700}.tv{color:#5511aa;font-weight:700}.footer{margin-top:28px;padding-top:16px;border-top:1px solid #eee;text-align:center;color:#bbb;font-size:11px}@media print{.no-print{display:none}}</style></head><body>
<h1>Vault LK</h1><div class="sub">Report: ${label} &nbsp;Â·&nbsp; ${D.user.name} &nbsp;Â·&nbsp; Generated: ${new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'})}</div>
<div class="grid"><div class="box"><div class="box-l">Income</div><div class="box-v g">${rs(inc)}</div></div><div class="box"><div class="box-l">Expenses</div><div class="box-v r">${rs(exp)}</div></div><div class="box"><div class="box-l">Savings</div><div class="box-v b">${rs(sav)}</div></div><div class="box"><div class="box-l">Invested</div><div class="box-v p">${rs(inv)}</div></div></div>
<h2>Transactions</h2><table><tr><th>Date</th><th>Type</th><th>Description</th><th>Category</th><th>Amount</th></tr>${txs.map(t=>`<tr><td>${fmtD(t.date)}</td><td class="t${t.type[0]}">${t.type.toUpperCase()}</td><td>${t.desc}</td><td>${(t.category||'').replace(/^.\s/,'')}</td><td class="t${t.type[0]}">${rs(t.amount)}</td></tr>`).join('')||'<tr><td colspan="5" style="text-align:center;color:#bbb;padding:20px">No transactions</td></tr>'}</table>
<h2>Spending by Category</h2><table><tr><th>Category</th><th>Amount</th><th>% of Expenses</th></tr>${Object.entries(bycat).sort((a,b)=>b[1]-a[1]).map(([c,v])=>`<tr><td>${c}</td><td>${rs(v)}</td><td>${exp>0?((v/exp)*100).toFixed(1):0}%</td></tr>`).join('')||'<tr><td colspan="3">None</td></tr>'}</table>
<h2>Savings Accounts</h2><table><tr><th>Account</th><th>Balance</th><th>Rate</th></tr>${D.savings.map(s=>`<tr><td>${s.name}</td><td>${rs(s.balance)}</td><td>${s.rate}% p.a.</td></tr>`).join('')||'<tr><td colspan="3">None</td></tr>'}</table>
<h2>Investment Portfolio</h2><table><tr><th>Name</th><th>Type</th><th>Cost</th><th>Value</th><th>Return</th></tr>${D.investments.map(i=>`<tr><td>${i.name}</td><td>${i.type}</td><td>${rs(i.cost)}</td><td>${rs(i.currentValue)}</td><td class="${i.currentValue>=i.cost?'g':'r'}">${i.currentValue>=i.cost?'+':''}${rs(i.currentValue-i.cost)}</td></tr>`).join('')||'<tr><td colspan="5">None</td></tr>'}</table>
<div class="footer">Vault LK Â· Personal Finance Â· Sri Lanka Â· ${new Date().getFullYear()}</div>
<br class="no-print"><button class="no-print" onclick="window.print()" style="padding:10px 20px;background:#06080f;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:14px">ğŸ–¨ï¸ Print / Save PDF</button>
</body></html>`);w.document.close();toastM('ğŸ“„ PDF report opened!');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   VAULT AI CHATBOT (Claude-powered)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let chatHistory=[];
function openChat(){
  document.getElementById('chatPanel').classList.add('on');
  const statusTxt=document.getElementById('chatStatusTxt');
  if(statusTxt) statusTxt.textContent=navigator.onLine?'AI-powered Â· Online':'Smart mode Â· Offline';
  if(!chatHistory.length) addChatMsg('ai',`ğŸ‘‹ Hi ${D.user.name||'there'}! I'm Vault AI. I have full access to your financial data and can give you personalized advice. What would you like to know?`);
}
function closeChat(){document.getElementById('chatPanel').classList.remove('on');}

function askQuick(q){
  const inp=document.getElementById('chatInput');
  inp.value=q;
  sendChat();
}

function addChatMsg(role,text){
  const msgs=document.getElementById('chatMessages');
  const div=document.createElement('div');
  div.className=`chat-msg ${role}`;
  const initials=D.user.name?(D.user.name[0].toUpperCase()):'U';
  const avaContent=role==='user'?(D.user.avatar?`<img src="${D.user.avatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover" alt="">`:(initials)):('ğŸ¤–');
  div.innerHTML=`<div class="msg-ava ${role}">${avaContent}</div><div class="msg-bubble">${text.replace(/\n/g,'<br>')}</div>`;
  msgs.appendChild(div);
  msgs.scrollTop=msgs.scrollHeight;
}

let typingEl=null;
function showTyping(){
  const msgs=document.getElementById('chatMessages');
  const div=document.createElement('div');
  div.className='chat-msg ai';div.id='typingIndicator';
  div.innerHTML=`<div class="msg-ava ai">ğŸ¤–</div><div class="msg-bubble"><div class="typing"><span></span><span></span><span></span></div></div>`;
  msgs.appendChild(div);msgs.scrollTop=msgs.scrollHeight;typingEl=div;
}
function hideTyping(){if(typingEl){typingEl.remove();typingEl=null;}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   SMART OFFLINE AI â€” Deep Sri Lanka Finance Knowledge
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SL_KNOWLEDGE = {
  banks: `Sri Lanka's main banks and their products (2024-2025):\nâ€¢ Bank of Ceylon (BOC): FD rates 11-13%, savings 5-7%, personal loans from 14%\nâ€¢ People's Bank: FD 11-13%, Ran Aruwa savings account for gold, pawning services\nâ€¢ NSB (National Savings Bank): FD up to 13.5%, children's savings, bonus interest on long-term deposits\nâ€¢ Sampath Bank: FD 12-13.5%, digital banking, personal loans 16-20%\nâ€¢ Commercial Bank: FD 11-13%, SME loans, home loans from 14%\nâ€¢ Hatton National Bank (HNB): FD 11-12.5%, HNB Solo for young professionals\nâ€¢ Seylan Bank: FD 11-13%, Seylan Tikiri children savings\nâ€¢ NDB Bank: FD 12-13%, wealth management, investment products\nâ€¢ DFCC Bank: FD 11-12%, housing loans, project finance\nTip: Compare FD rates monthly â€” they change with CBSL policy rate changes.`,

  investment: `Investment options in Sri Lanka:\n\nğŸ“Š Unit Trusts (Lowest risk entry point):\nâ€¢ Ceybank Unit Trust, NDB Wealth, Comtrust, First Capital\nâ€¢ Money market funds: 8-11% returns, high liquidity\nâ€¢ Balanced funds: 10-15% average annual returns\nâ€¢ Minimum investment: Rs.5,000-25,000\n\nğŸ“ˆ Colombo Stock Exchange (CSE):\nâ€¢ Blue chip stocks: JKH, Dialog, Commercial Bank, Hayleys\nâ€¢ Sector leaders: Banking (COMB, HNB), Telecom (DIAL), Conglomerates (JKH)\nâ€¢ P/E ratios currently attractive post-2022 crisis recovery\nâ€¢ Use a registered stockbroker: CT Smith, Asia Securities, Acuity\nâ€¢ CDS account required â€” open at any CSE member broker\n\nğŸ¥‡ Gold:\nâ€¢ Sovereign gold backed by state, inflation hedge\nâ€¢ Buy at People's Bank Ran Aruwa or BOC\nâ€¢ Gold coins available at State Gem & Jewellery Authority\nâ€¢ ETFs not widely available â€” physical gold preferred\n\nğŸ  Real Estate:\nâ€¢ Colombo apartment: Rs.8M-30M+ per unit\nâ€¢ REITs not yet mainstream in Sri Lanka\nâ€¢ Land outside Colombo: better value, lower liquidity\nâ€¢ Rental yield in Colombo: 4-6% annually\n\nğŸ’ Fixed Deposits (Safest):\nâ€¢ BOC, NSB, People's Bank government-backed â€” safest\nâ€¢ Private bank FDs: higher rates but slightly more risk\nâ€¢ Minimum 1 month to 5 years\nâ€¢ Interest taxed at 5% withholding tax`,

  tax: `Sri Lanka Tax Guide (2024-2025):\n\nğŸ’¼ Personal Income Tax (PAYE):\nâ€¢ Tax-free threshold: Rs.1,800,000/year (Rs.150,000/month)\nâ€¢ 6% on next Rs.500,000\nâ€¢ 12% on next Rs.500,000\nâ€¢ 18% on next Rs.500,000\nâ€¢ 24% on next Rs.500,000\nâ€¢ 30% above Rs.3,300,000/year\nâ€¢ File with IRD online at ird.gov.lk\n\nğŸ¢ VAT: 18% standard rate (increased 2024)\n\nğŸ“¦ Corporate Tax: 30% standard, 14% for small businesses under Rs.5M profit\n\nğŸ’° Withholding Tax:\nâ€¢ FD interest: 5%\nâ€¢ Dividends: 15%\nâ€¢ Rent: 10%\n\nğŸ Tax reliefs:\nâ€¢ Qualifying payments: up to Rs.1.2M deductible (insurance, donations)\nâ€¢ EPF/ETF contributions deductible\nâ€¢ Medical expenses partially deductible\n\nFile returns by November 30 for previous year. Use e-services at ird.gov.lk`,

  epf_etf: `EPF & ETF Guide for Sri Lanka:\n\nğŸ¦ EPF (Employees Provident Fund):\nâ€¢ Employee contribution: 8% of gross salary\nâ€¢ Employer contribution: 12% of gross salary\nâ€¢ Total: 20% of salary goes to EPF\nâ€¢ Managed by CBSL â€” currently earning ~9-11% annual returns\nâ€¢ Can withdraw at age 55, retirement, or emigration\nâ€¢ Partial withdrawal: for housing (after 10 years membership)\nâ€¢ Check balance at epf.cbsl.gov.lk or any Labour Dept office\nâ€¢ Refund takes 3-6 months after claim\n\nğŸ“‹ ETF (Employees Trust Fund):\nâ€¢ Employer pays 3% of gross salary\nâ€¢ Employee gets full benefit on retirement/resignation\nâ€¢ Can be used as collateral for loans\nâ€¢ Managed by ETF Board\nâ€¢ Apply for benefits at etfb.lk\n\nğŸ’¡ Tips:\nâ€¢ Always ensure employer is depositing correctly â€” check monthly\nâ€¢ Voluntary EPF members: Rs.500 minimum per month\nâ€¢ Private sector EPF is mandatory â€” if employer not contributing, report to Labour Dept`,

  inflation: `Sri Lanka Inflation & Cost of Living (2024-2025):\n\nğŸ“Š Current situation:\nâ€¢ Inflation returned to single digits (4-6%) after 2022 peak of 70%\nâ€¢ CBSL reduced policy rates from 16.5% to around 8-9% by 2024\nâ€¢ LKR stabilized around Rs.290-310 per USD\n\nğŸ›’ Monthly cost of living estimates:\nâ€¢ Colombo single person: Rs.60,000-120,000\nâ€¢ Colombo family of 4: Rs.150,000-280,000\nâ€¢ Kandy/Galle: 20-30% lower than Colombo\nâ€¢ Jaffna/other districts: 30-40% lower\n\nğŸ¥˜ Food basket (monthly family):\nâ€¢ Rice: Rs.3,000-5,000\nâ€¢ Vegetables: Rs.6,000-10,000\nâ€¢ Fish/Meat: Rs.8,000-15,000\nâ€¢ Milk/Dairy: Rs.3,000-6,000\nâ€¢ Total food: Rs.30,000-50,000 for family of 4\n\nâš¡ Utilities:\nâ€¢ Electricity (household): Rs.2,000-8,000\nâ€¢ Water: Rs.500-2,000\nâ€¢ Internet (fiber 100Mbps): Rs.2,500-4,000\nâ€¢ Mobile data (20GB): Rs.800-1,500`,

  loans: `Loan Guide for Sri Lanka:\n\nğŸ  Home Loans:\nâ€¢ Commercial Bank, HNB, BOC: from 14-16% floating rate\nâ€¢ NHDA (National Housing Development Authority): subsidized loans for first-time buyers\nâ€¢ Maximum term: 25-30 years\nâ€¢ LTV: up to 70-80% of property value\nâ€¢ Tip: Fixed vs floating â€” currently fixed is safer\n\nğŸš— Vehicle Loans:\nâ€¢ Banks: 18-22% interest, up to 7 years\nâ€¢ Finance companies (Peoples Leasing, LB Finance): faster approval, 20-25%\nâ€¢ Imported vehicles: harder to finance post-2022, high taxes\n\nğŸ’¼ Personal Loans:\nâ€¢ Banks: 18-24% interest\nâ€¢ Microfinance: 24-36% (avoid if possible)\nâ€¢ Maximum term: 7 years\nâ€¢ Requires salary slip, 6 months bank statement, EPF statement\n\nğŸ“± Digital Lending:\nâ€¢ Solo (HNB), Wave Money, mCash â€” quick small loans\nâ€¢ Higher interest rates (24-36%) â€” use only for emergencies\n\nğŸ’¡ Golden rule: Total debt repayments should not exceed 30-35% of gross monthly income.\nâ€¢ If your salary is Rs.100,000, keep all EMIs under Rs.35,000`,

  budgeting: `Smart Budgeting for Sri Lanka:\n\nğŸ“ The 50/30/20 Rule (adapted for LK):\nâ€¢ 50% Needs: rent, food, transport, utilities, loan EMIs\nâ€¢ 30% Wants: dining out, entertainment, shopping, subscriptions\nâ€¢ 20% Savings & investments: FD, EPF top-up, unit trusts\n\nğŸ¯ Sri Lanka specific tips:\nâ€¢ Keep 3-6 months expenses as emergency fund (Rs.150,000-500,000)\nâ€¢ Budget separately for festive seasons: Avurudu (April), Christmas, Deepavali â€” these spike spending by 30-50%\nâ€¢ Factor in school fees: Rs.5,000-50,000/term for private schools\nâ€¢ Vehicle running cost: Rs.15,000-40,000/month (fuel, maintenance, insurance)\n\nğŸ“± Zero-based budgeting:\nâ€¢ Assign every rupee a job at month start\nâ€¢ Income - All planned expenses = 0\nâ€¢ Unplanned expense = adjust another category\n\nâš ï¸ Common Sri Lanka budget traps:\nâ€¢ Hire purchase (HP) for electronics â€” very high effective interest\nâ€¢ Rotating credit (polite term for informal lending groups â€” risky)\nâ€¢ Lottery/gambling â€” never a financial strategy\nâ€¢ Keeping too much cash at home â€” loses value to inflation`,

  savings: `Savings Strategy for Sri Lanka:\n\nğŸ† Savings hierarchy (best to start with):\n1. Emergency fund â€” 3-6 months expenses in a savings account (NSB/BOC â€” safest)\n2. EPF top-up â€” voluntary contributions earn 9-11%\n3. Fixed Deposit â€” lock in 12-13.5% for 1-2 years\n4. Unit Trust money market fund â€” liquid, 8-11%\n5. CSE stocks or unit trust equity fund â€” 10-18% long term\n\nğŸ’¡ Automation tricks:\nâ€¢ Set standing order on payday to auto-transfer to savings\nâ€¢ "Pay yourself first" â€” save before spending\nâ€¢ Round up purchases to nearest Rs.100 and save the difference\n\nğŸ¯ Target savings by age (Sri Lanka context):\nâ€¢ Age 25: 3 months emergency fund\nâ€¢ Age 30: 6 months expenses + Rs.500K invested\nâ€¢ Age 35: Rs.2M+ invested, home loan in progress\nâ€¢ Age 40: Rs.5M+ net worth goal\nâ€¢ Age 55: EPF + investments to cover 20+ years retirement\n\nğŸ“Š Simple savings rate targets:\nâ€¢ Minimum: 10% of income\nâ€¢ Good: 20% of income\nâ€¢ Excellent: 30%+ of income`,

  retirement: `Retirement Planning in Sri Lanka:\n\nğŸ‘´ Retirement age: 55 (private sector EPF access), 60 (public servants)\n\nğŸ’° How much do you need?\nâ€¢ Rule of thumb: 25x your annual expenses at retirement\nâ€¢ If you spend Rs.100,000/month = Rs.1.2M/year\nâ€¢ Target: Rs.30,000,000 (Rs.30M) retirement corpus\n\nğŸ“Š Sources of retirement income:\n1. EPF lump sum (can be converted to annuity)\n2. ETF benefit\n3. Personal investments (FDs, unit trusts, stocks)\n4. Rental income from property\n5. Pension (government employees only)\n\nğŸ”¢ Retirement calculator example:\nâ€¢ Age 30 now, retire at 55 (25 years)\nâ€¢ Invest Rs.20,000/month\nâ€¢ At 12% annual return: corpus â‰ˆ Rs.36M\nâ€¢ At 10% annual return: corpus â‰ˆ Rs.27M\n\nâš ï¸ Sri Lanka-specific risks:\nâ€¢ Currency devaluation â€” diversify into USD assets\nâ€¢ Inflation eroding fixed income\nâ€¢ Lack of social security net â€” fully self-reliant\nâ€¢ Healthcare costs rise significantly after 60\n\nğŸ’¡ Start as early as possible â€” compound interest is your biggest ally`,

  insurance: `Insurance in Sri Lanka:\n\nğŸ¥ Health Insurance:\nâ€¢ AIA, Ceylinco, Softlogic Life, Sri Lanka Insurance\nâ€¢ Individual plan: Rs.2,000-6,000/month for basic cover\nâ€¢ Family floater: Rs.5,000-15,000/month\nâ€¢ Key: check hospital network â€” Lanka Hospitals, Nawaloka, Asiri, Durdans\nâ€¢ Government hospitals are free but quality varies\n\nğŸš— Motor Insurance:\nâ€¢ Third-party: mandatory, Rs.3,000-8,000/year\nâ€¢ Comprehensive: Rs.15,000-60,000/year depending on vehicle\nâ€¢ Compare at IME, Ceylinco General, Allianz\n\nğŸ  Home Insurance:\nâ€¢ Under-utilized in Sri Lanka â€” highly recommended\nâ€¢ Covers fire, flood, burglary\nâ€¢ Rs.2,000-8,000/year for average home\n\nğŸ’¼ Life Insurance:\nâ€¢ Term insurance: cheapest, most coverage\nâ€¢ Rs.10M cover for 20 years: ~Rs.1,500-3,000/month (age 30)\nâ€¢ Endowment/Whole life: savings + insurance â€” lower returns than pure investment\nâ€¢ Ceylinco Life, AIA, Union Assurance, Sri Lanka Insurance\n\nğŸ’¡ Rule: Never mix insurance and investment. Buy term insurance + invest the difference separately.`,

  sideIncome: `Side Income Ideas for Sri Lanka:\n\nğŸ’» Online/Remote work (best ROI):\nâ€¢ Freelancing: Upwork, Fiverr, Toptal â€” graphic design, coding, writing, marketing\nâ€¢ Content creation: YouTube (English content earns more), TikTok\nâ€¢ Teaching online: Preply, iTalki for English teaching â€” $15-25/hour\nâ€¢ Data entry, virtual assistant on remote job boards\n\nğŸª Local business ideas:\nâ€¢ Home bakery/food business: festive seasons are goldmines\nâ€¢ Tuition classes: maths, science, English â€” Rs.2,000-5,000/student/month\nâ€¢ Delivery services: PickMe, Uber Eats partner\nâ€¢ Photography/videography for events\nâ€¢ Clothing resale (thrift/secondhand market growing)\n\nğŸŒ Passive income:\nâ€¢ YouTube channel (takes 1-2 years to monetize)\nâ€¢ Rent a room/annex\nâ€¢ Rent vehicle on short-term rental\nâ€¢ FD interest â€” Rs.1M FD at 13% = Rs.10,833/month\n\nâš ï¸ Avoid:\nâ€¢ MLM/pyramid schemes (rampant in Sri Lanka)\nâ€¢ "Online investment" schemes promising 20%+/month returns\nâ€¢ Finance company deposits above 15% â€” very high risk\nâ€¢ Any scheme requiring upfront payment to join`,

  crypto: `Cryptocurrency in Sri Lanka:\n\nâš ï¸ Legal status: Grey area â€” not banned but not regulated. CBSL has warned against crypto.\n\nğŸ“Š Current situation (2024-2025):\nâ€¢ No dedicated crypto exchange in Sri Lanka\nâ€¢ International exchanges used: Binance, Coinbase (with VPN sometimes needed)\nâ€¢ Payments in crypto not legally accepted\nâ€¢ Tax on crypto profits: unclear, but IRD may treat as income\n\nğŸ’¡ If you still want to invest:\nâ€¢ Limit to 5-10% of investment portfolio maximum\nâ€¢ Only invest what you can afford to lose entirely\nâ€¢ Bitcoin and Ethereum are least volatile among crypto\nâ€¢ Use hardware wallet for security (Ledger, Trezor)\nâ€¢ KYC required on major exchanges â€” use your real identity\n\nğŸ¦ Better Sri Lanka alternatives with similar growth potential:\nâ€¢ CSE blue chip stocks during market downturns\nâ€¢ Unit trust equity funds for managed risk\nâ€¢ USD-denominated FDs (if available) for currency hedge`,

  forex: `Foreign Exchange & Remittances Sri Lanka:\n\nğŸ’± Current exchange rates (approximate 2024-2025):\nâ€¢ USD: Rs.290-315\nâ€¢ EUR: Rs.310-340\nâ€¢ GBP: Rs.360-400\nâ€¢ AUD: Rs.185-210\nâ€¢ SGD: Rs.215-240\nâ€¢ INR: Rs.3.3-3.7\n\nğŸ“¤ Sending money to Sri Lanka (inward remittance):\nâ€¢ Bank transfers: Commercial Bank, HNB, BOC â€” competitive rates\nâ€¢ Western Union, MoneyGram: convenient but higher fees\nâ€¢ Wise (TransferWise): best rates for USD/EUR/GBP to LKR\nâ€¢ IME, Al-Ansari: popular for Middle East workers\nâ€¢ Remittances are duty-free and not taxed\n\nğŸ’¡ For Sri Lanka workers abroad:\nâ€¢ Declare remittances through official banking channels\nâ€¢ Hawala/Undiyal is illegal â€” avoid\nâ€¢ CBSL allows holding foreign currency accounts in Sri Lanka\nâ€¢ Exchange at banks for best rates â€” avoid street exchangers`,

  housing: `Housing & Property in Sri Lanka:\n\nğŸ  Buying property:\nâ€¢ Colombo 3, 5, 7: Rs.25-60M for apartment, Rs.60M+ for house\nâ€¢ Colombo suburbs (Nugegoda, Maharagama, Dehiwala): Rs.15-35M\nâ€¢ Kandy city: Rs.10-25M for house\nâ€¢ Galle/Matara: Rs.8-20M for house\nâ€¢ Northern provinces: Rs.3-12M â€” recovering slowly post-war\n\nğŸ“‹ Buying process:\nâ€¢ Lawyer (Notary Public) required â€” fee 1-2% of property value\nâ€¢ Stamp duty: 4% on transfer\nâ€¢ Land registry fee: ~1%\nâ€¢ Budget 6-8% on top of property price for all costs\n\nğŸ—ï¸ Building a house:\nâ€¢ Construction cost: Rs.15,000-35,000 per sq ft (2024)\nâ€¢ 1,500 sq ft house: Rs.22M-52M build cost\nâ€¢ Add land cost separately\nâ€¢ Architect fee: 3-5% of build cost\n\nğŸ¢ Renting:\nâ€¢ Colombo 1-bedroom: Rs.40,000-120,000/month\nâ€¢ Colombo 3-bedroom: Rs.80,000-300,000/month\nâ€¢ Suburbs 2-bedroom: Rs.25,000-60,000/month\nâ€¢ Kandy 2-bedroom: Rs.20,000-45,000/month`,

  cbsl: `Central Bank of Sri Lanka (CBSL) Key Rates (2024-2025):\n\nğŸ¦ Policy rates:\nâ€¢ Standing Deposit Facility Rate (SDFR): ~8.25%\nâ€¢ Standing Lending Facility Rate (SLFR): ~9.25%\nâ€¢ Statutory Reserve Ratio (SRR): ~2%\n\nğŸ“Š What these mean for you:\nâ€¢ Lower policy rates = lower FD rates but cheaper loans\nâ€¢ CBSL reduced rates aggressively in 2023-2024 as inflation fell\nâ€¢ Inflation target: 4-6% mid-term\n\nğŸ’± Exchange rate:\nâ€¢ CBSL moved to flexible exchange rate in 2022\nâ€¢ LKR stabilized after managed float\nâ€¢ Check daily rates at cbsl.gov.lk\n\nğŸ“‹ Useful CBSL services:\nâ€¢ Consumer complaints about banks: 1800 011 900 (toll-free)\nâ€¢ Check licensed finance companies list before depositing\nâ€¢ Financial consumer education at cbsl.gov.lk/consumer-financial-literacy`,

  stocks_cse: `Colombo Stock Exchange (CSE) Investing Guide:\n\nğŸ“ˆ How to start:\n1. Choose a licensed stockbroker (CT Smith, Asia Securities, NDB Securities, First Capital)\n2. Open CDS (Central Depository System) account â€” free, takes 1-2 days\n3. Deposit funds and start trading\n4. Mobile apps: CSE mobile app, broker apps\n\nğŸ† Top companies by sector (2024):\nâ€¢ Banking: Commercial Bank (COMB), HNB, Sampath, Seylan\nâ€¢ Conglomerates: John Keells Holdings (JKH), Hayleys, Aitken Spence\nâ€¢ Telecom: Dialog Axiata (DIAL), SLT-Mobitel\nâ€¢ Insurance: AIA, Ceylinco Insurance\nâ€¢ Beverage: Lion Brewery, Ceylon Cold Stores\nâ€¢ Healthcare: Nawaloka Hospitals, Asiri Hospital\n\nğŸ“Š Key metrics to check:\nâ€¢ P/E ratio: below 10 = potentially undervalued for LK market\nâ€¢ Dividend yield: 3-8% is typical for LK blue chips\nâ€¢ Market cap: stick to large caps for less risk\n\nğŸ’¡ Sri Lanka market characteristics:\nâ€¢ Small, relatively illiquid compared to regional markets\nâ€¢ Heavily retail investor driven â€” herd behavior common\nâ€¢ Post-2022 recovery â€” many stocks still below 2021 peaks\nâ€¢ Dividend culture strong â€” many companies pay regular dividends`,

  vehicle: `Vehicle Costs in Sri Lanka (2024-2025):\n\nğŸš— Import taxes (why vehicles are expensive):\nâ€¢ Tax + duties can be 100-300% of CIF value\nâ€¢ Budget vehicle (hybrid 1500cc): Rs.6M-12M\nâ€¢ Mid-range (2000cc sedan): Rs.12M-25M\nâ€¢ SUV: Rs.20M-60M+\nâ€¢ Electric vehicles: lower taxes, gaining popularity\n\nâ›½ Running costs monthly:\nâ€¢ Petrol (92 octane): ~Rs.350/litre (Â±LKR fluctuations)\nâ€¢ Monthly fuel 1,000km: Rs.25,000-45,000 depending on vehicle\nâ€¢ Insurance (comprehensive): Rs.1,500-5,000/month\nâ€¢ Maintenance: Rs.3,000-8,000/month average\nâ€¢ Total vehicle cost: Rs.30,000-60,000/month\n\nğŸ›µ Motorbike alternative:\nâ€¢ Honda Wave/Suzuki GS: Rs.400,000-600,000\nâ€¢ Running cost: Rs.5,000-10,000/month\nâ€¢ Much more cost-effective for single person\n\nğŸšŒ Public transport:\nâ€¢ Bus: Rs.10-150 per trip\nâ€¢ Train: Rs.20-200 per trip\nâ€¢ PickMe/Uber: Rs.200-800 per short trip\nâ€¢ Savings vs car: Rs.25,000-50,000/month`
};

function getLocalAIResponse(msg){
  const m = msg.toLowerCase();

  // â”€â”€ Gather user data â”€â”€
  const inc    = D.txs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  const exp    = D.txs.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
  const savTx  = D.txs.filter(t=>t.type==='saving').reduce((s,t)=>s+t.amount,0);
  const invTx  = D.txs.filter(t=>t.type==='investment').reduce((s,t)=>s+t.amount,0);
  const mInc   = D.txs.filter(t=>t.type==='income'&&inPeriod(t,'monthly')).reduce((s,t)=>s+t.amount,0);
  const mExp   = D.txs.filter(t=>t.type==='expense'&&inPeriod(t,'monthly')).reduce((s,t)=>s+t.amount,0);
  const wExp   = D.txs.filter(t=>t.type==='expense'&&inPeriod(t,'weekly')).reduce((s,t)=>s+t.amount,0);
  const dExp   = D.txs.filter(t=>t.type==='expense'&&inPeriod(t,'daily')).reduce((s,t)=>s+t.amount,0);
  const savBal = D.savings.reduce((s,a)=>s+a.balance,0)+savTx;
  const invBal = D.investments.reduce((s,i)=>s+i.currentValue,0)+invTx;
  const nw     = inc-exp+savBal+invBal;
  const sr     = mInc>0?(((mInc-mExp)/mInc)*100).toFixed(1):0;
  const bycat  = {};
  D.txs.filter(t=>t.type==='expense').forEach(t=>{bycat[t.category]=(bycat[t.category]||0)+t.amount;});
  const topCats = Object.entries(bycat).sort((a,b)=>b[1]-a[1]).slice(0,3);

  // â”€â”€ Topic matching â”€â”€

  // Greetings / help menu
  if(m.match(/^(hi|hello|hey|help|start|what can|menu|options)/)){
    return `ğŸ‘‹ Hi ${D.user.name||'there'}! I'm Vault AI â€” I know your finances AND I'm packed with Sri Lanka financial knowledge.\n\nAsk me about:\nğŸ“Š "How am I doing this month?"\nğŸ’° "How to save more?"\nğŸ¦ "Best bank for FD?"\nğŸ“ˆ "How to invest in CSE?"\nğŸ  "Property prices in Sri Lanka"\nğŸ’¼ "EPF and ETF guide"\nğŸš— "Vehicle costs and loans"\nğŸ’Š "Tax guide Sri Lanka"\nğŸ¯ "How to reach my goals?"\nğŸ’³ "Loan advice"\nğŸ›¡ï¸ "Insurance guide"\nğŸ’µ "Side income ideas"\nğŸŒ "Forex and remittances"\nğŸ“‰ "Crypto in Sri Lanka"\n\nOr anything else about your money! ğŸ‡±ğŸ‡°`;
  }

  // Monthly/weekly/daily summary
  if(m.includes('this month')||m.includes('monthly')||(m.includes('how am i')||m.includes('summary')||m.includes('overview'))){
    const budStatus = D.budgets.monthly>0 ? `Budget: ${rsK(mExp)} of ${rsK(D.budgets.monthly)} (${((mExp/D.budgets.monthly)*100).toFixed(0)}% used).` : 'No monthly budget set â€” set one in Profile!';
    const topStr = topCats.length ? `\nTop 3 expense categories:\n${topCats.map(([c,v])=>`  â€¢ ${(c||'').replace(/^.\s/,'')}: ${rsK(v)}`).join('\n')}` : '';
    return `ğŸ“Š YOUR MONTH SO FAR\n\nğŸ’š Income: ${rsK(mInc)}\nğŸ”´ Expenses: ${rsK(mExp)}\nğŸ’° Net this month: ${rsK(mInc-mExp)}\nğŸ“ˆ Savings rate: ${sr}%\nâ±ï¸ Daily avg spend: ${rsK(mExp/new Date().getDate())}\n\n${budStatus}${topStr}\n\n${Number(sr)>=20?'ğŸ† Excellent savings rate! Keep it up.':Number(sr)>=10?'ğŸ‘ Decent rate. Push towards 20% for stronger financial health.':'âš ï¸ Low savings rate. Review your top expenses and find Rs.5,000-10,000 to redirect to savings.'}`;
  }

  // Net worth
  if(m.includes('net worth')||m.includes('wealth')||m.includes('total worth')){
    return `ğŸ’ YOUR NET WORTH SNAPSHOT\n\nğŸ“¥ Total income logged: ${rsK(inc)}\nğŸ“¤ Total expenses: ${rsK(exp)}\nğŸ¦ Savings balance: ${rsK(savBal)}\nğŸ“ˆ Investment value: ${rsK(invBal)}\n\nâœ¨ Estimated Net Worth: ${rsK(nw)}\n\n${nw>1000000?`You've crossed the Rs.${(nw/1000000).toFixed(1)}M mark! ğŸ‰`:'Keep building â€” each rupee saved and invested compounds over time.'}\n\nğŸ’¡ Tip: True net worth = all assets (savings + investments + property value + vehicle) minus all liabilities (loans + credit cards + debts). Update your savings & investments in Profile for accuracy.`;
  }

  // Weekly
  if(m.includes('this week')||m.includes('weekly')){
    return `ğŸ“… THIS WEEK\n\nExpenses: ${rsK(wExp)}\nDaily average: ${rsK(wExp/7)}\n${D.budgets.weekly>0?`Weekly budget: ${rsK(D.budgets.weekly)} | Used: ${((wExp/D.budgets.weekly)*100).toFixed(0)}%\nRemaining: ${rsK(Math.max(0,D.budgets.weekly-wExp))}`:''}\n\n${topCats.length?`Top spending:\n${topCats.map(([c,v])=>`  â€¢ ${(c||'').replace(/^.\s/,'')}: ${rsK(v)}`).join('\n')}`:''}\n\nğŸ’¡ At this weekly rate, monthly spend = ~${rsK(wExp*4.33)}`;
  }

  // Today
  if(m.includes('today')||m.includes('daily spend')){
    return `ğŸ“… TODAY\nSpent: ${rsK(dExp)}\n${D.budgets.daily>0?`Daily budget: ${rsK(D.budgets.daily)} | ${dExp>D.budgets.daily?`âš ï¸ Over by ${rsK(dExp-D.budgets.daily)}`:`Remaining: ${rsK(D.budgets.daily-dExp)}`}`:'No daily budget set.'}\n\nğŸ’¡ Tip: Rs.500/day saved = Rs.180,000/year. Small daily habits create big annual results.`;
  }

  // Goals
  if(m.includes('goal')||m.includes('target')||m.includes('saving for')){
    if(!D.goals.length) return `ğŸ¯ NO GOALS SET YET!\n\nGoals give your savings a purpose. Ideas:\nâ€¢ Emergency fund: 3-6 months expenses\nâ€¢ Vehicle: Budget for 30% down payment\nâ€¢ House: Save for down payment (20-30%)\nâ€¢ Children's education: Rs.2M-10M needed\nâ€¢ Retirement corpus: 25x annual expenses\n\nTap the Goals tab (ğŸ¯) to add your first goal!`;
    const goalDetails = D.goals.map(g=>{
      const pct=((g.saved/g.target)*100).toFixed(0);
      const rem=g.target-g.saved;
      const months=g.monthly>0?Math.ceil(rem/g.monthly):null;
      return `${g.emoji||'ğŸ¯'} ${g.name}\n  Progress: ${pct}% (${rsK(g.saved)} of ${rsK(g.target)})\n  Remaining: ${rsK(rem)}${months?`\n  ETA: ~${months} months at ${rsK(g.monthly)}/month`:''}${Number(pct)>=90?' ğŸ”¥ Almost there!':Number(pct)>=50?' âœ… Halfway!':''}`;
    }).join('\n\n');
    return `ğŸ¯ YOUR GOALS\n\n${goalDetails}\n\nğŸ’¡ Tip: Automate savings transfers on payday so goal contributions happen automatically before you can spend.`;
  }

  // Banks / FD
  if(m.includes('bank')||m.includes('fixed deposit')||m.includes(' fd ')||m.includes('interest rate')||m.includes('nsb')||m.includes('boc')||m.includes('peoples bank')){
    return SL_KNOWLEDGE.banks;
  }

  // Investment / CSE / stocks / unit trust
  if(m.includes('invest')||m.includes('stock')||m.includes('cse')||m.includes('unit trust')||m.includes('shares')||m.includes('mutual fund')){
    if(m.includes('cse')||m.includes('stock')||m.includes('shares')) return SL_KNOWLEDGE.stocks_cse;
    return SL_KNOWLEDGE.investment;
  }

  // Tax
  if(m.includes('tax')||m.includes('ird')||m.includes('paye')||m.includes('vat')||m.includes('income tax')){
    return SL_KNOWLEDGE.tax;
  }

  // EPF / ETF
  if(m.includes('epf')||m.includes('etf')||m.includes('provident')||m.includes('trust fund')||m.includes('pension')){
    return SL_KNOWLEDGE.epf_etf;
  }

  // Inflation / cost of living
  if(m.includes('inflation')||m.includes('cost of living')||m.includes('prices')||m.includes('expensive')||m.includes('afford')){
    return SL_KNOWLEDGE.inflation;
  }

  // Loans / credit
  if(m.includes('loan')||m.includes('borrow')||m.includes('credit')||m.includes('debt')||m.includes('emi')||m.includes('mortgage')||m.includes('leasing')){
    return SL_KNOWLEDGE.loans;
  }

  // Budgeting tips
  if(m.includes('budget')||m.includes('budgeting')||m.includes('spending')||m.includes('cut cost')||m.includes('save more')||m.includes('spend less')){
    const topStr = topCats.length?`\nYour top expense categories:\n${topCats.map(([c,v],i)=>`  ${i+1}. ${(c||'').replace(/^.\s/,'')}: ${rsK(v)}`).join('\n')}\n`:'';
    return `${SL_KNOWLEDGE.budgeting}\n\nğŸ“Š YOUR CURRENT SITUATION${topStr}\nMonthly budget set: ${D.budgets.monthly>0?rsK(D.budgets.monthly):'Not set â€” add in Profile'}\nThis month spent: ${rsK(mExp)}\nSavings rate: ${sr}%`;
  }

  // Savings advice
  if(m.includes('save')||m.includes('saving')||m.includes('emergency fund')){
    return `${SL_KNOWLEDGE.savings}\n\nğŸ“Š YOUR SAVINGS STATUS\nTotal savings logged: ${rsK(savBal)}\nThis month saved: ${rsK(D.txs.filter(t=>t.type==='saving'&&inPeriod(t,'monthly')).reduce((s,t)=>s+t.amount,0))}\nSavings rate: ${sr}%\n${D.savings.length?`\nYour accounts:\n${D.savings.map(a=>`  â€¢ ${a.name}: ${rsK(a.balance)} @ ${a.rate}% p.a.`).join('\n')}`:'\nNo savings accounts added yet â€” add in Profile > Savings Accounts'}`;
  }

  // Retirement
  if(m.includes('retire')||m.includes('retirement')||m.includes('old age')||m.includes('future')){
    return SL_KNOWLEDGE.retirement;
  }

  // Insurance
  if(m.includes('insur')||m.includes('health cover')||m.includes('life cover')||m.includes('aia')||m.includes('ceylinco')){
    return SL_KNOWLEDGE.insurance;
  }

  // Side income / extra money
  if(m.includes('side')||m.includes('extra income')||m.includes('earn more')||m.includes('freelance')||m.includes('online earn')||m.includes('part time')||m.includes('business idea')){
    return SL_KNOWLEDGE.sideIncome;
  }

  // Crypto
  if(m.includes('crypto')||m.includes('bitcoin')||m.includes('ethereum')||m.includes('binance')||m.includes('blockchain')){
    return SL_KNOWLEDGE.crypto;
  }

  // Forex / remittance
  if(m.includes('forex')||m.includes('dollar')||m.includes('exchange rate')||m.includes('remit')||m.includes('usd')||m.includes('foreign')||m.includes('overseas')){
    return SL_KNOWLEDGE.forex;
  }

  // Housing / property
  if(m.includes('house')||m.includes('property')||m.includes('land')||m.includes('apartment')||m.includes('rent')||m.includes('real estate')){
    return SL_KNOWLEDGE.housing;
  }

  // Vehicle / car
  if(m.includes('car')||m.includes('vehicle')||m.includes('bike')||m.includes('motorbike')||m.includes('motor')||m.includes('fuel')||m.includes('transport')){
    return SL_KNOWLEDGE.vehicle;
  }

  // CBSL / Central Bank
  if(m.includes('cbsl')||m.includes('central bank')||m.includes('policy rate')||m.includes('interest rate')){
    return SL_KNOWLEDGE.cbsl;
  }

  // Specific spending analysis
  if(m.includes('where')&&(m.includes('spend')||m.includes('money going')||m.includes('money go'))){
    if(!topCats.length) return `ğŸ“Š No expense data yet! Start adding your expenses in the + tab to see where your money goes.\n\nCategories available:\nâ€¢ ğŸ› Food & Drink\nâ€¢ ğŸšŒ Transport\nâ€¢ ğŸ  Housing\nâ€¢ ğŸ’¡ Utilities\nâ€¢ ğŸ’Š Health\nâ€¢ ğŸ“š Education\nâ€¢ ğŸ¬ Entertainment\nâ€¢ ğŸ›’ Shopping`;
    return `ğŸ“Š WHERE YOUR MONEY GOES\n\nTotal expenses logged: ${rsK(exp)}\n\nTop categories:\n${Object.entries(bycat).sort((a,b)=>b[1]-a[1]).slice(0,6).map(([c,v],i)=>`  ${i+1}. ${(c||'').replace(/^.\s/,'')}: ${rsK(v)} (${exp>0?((v/exp)*100).toFixed(0):0}%)`).join('\n')}\n\nğŸ’¡ The #1 category (${(topCats[0]?.[0]||'').replace(/^.\s/,'')}) takes ${exp>0?((topCats[0]?.[1]/exp)*100).toFixed(0):0}% of total spending. If it's discretionary, try reducing by 10-15%.`;
  }

  // Advice / tips general
  if(m.includes('advice')||m.includes('tip')||m.includes('suggest')||m.includes('recommend')||m.includes('what should i')){
    const tips=[];
    if(Number(sr)<10) tips.push('ğŸ”´ Savings rate is low ('+sr+'%). Target 20% minimum.');
    if(D.budgets.monthly===0) tips.push('âš ï¸ No monthly budget set â€” set one in Profile > Budget Settings.');
    if(!D.goals.length) tips.push('ğŸ¯ No financial goals set â€” goals keep you motivated and focused.');
    if(D.savings.length===0) tips.push('ğŸ¦ No savings accounts tracked â€” add your NSB/bank accounts in Profile.');
    if(D.investments.length===0) tips.push('ğŸ“ˆ No investments tracked â€” consider a unit trust or FD as a start.');
    if(inc===0) tips.push('ğŸ’¼ No income logged yet â€” log your salary to unlock full AI insights.');
    if(!tips.length) tips.push('âœ… You\'re tracking well! Focus on growing investments and hitting your goals.');
    return `ğŸ’¡ PERSONALIZED ADVICE FOR ${(D.user.name||'you').toUpperCase()}\n\n${tips.join('\n')}\n\nWant deep advice on any topic? Ask me about:\nâ€¢ Savings, investments, budgeting\nâ€¢ Tax, EPF/ETF, insurance\nâ€¢ CSE stocks, unit trusts, FDs\nâ€¢ Side income, property, loans`;
  }

  // Default with rich context
  return `ğŸ¤– VAULT AI (Offline Mode)\n\nI didn't catch a specific topic, but here's your quick snapshot:\n\nğŸ’° Net worth: ${rsK(nw)}\nğŸ“Š This month: ${rsK(mInc)} in, ${rsK(mExp)} out\nğŸ’š Savings rate: ${sr}%\nğŸ¯ Active goals: ${D.goals.length}\n\nAsk me about:\nâ€¢ Monthly summary â€¢ Savings advice â€¢ Investment options\nâ€¢ Sri Lanka tax guide â€¢ EPF/ETF â€¢ Bank FD rates\nâ€¢ Loans & credit â€¢ Insurance â€¢ Side income ideas\nâ€¢ Property prices â€¢ Vehicle costs â€¢ Crypto in LK\nâ€¢ CSE stocks â€¢ Forex rates â€¢ Retirement planning\n\nType any topic or question! ğŸ‡±ğŸ‡°`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   UPGRADED ONLINE AI â€” Better system prompt
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildContext(){
  const inc=D.txs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  const exp=D.txs.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
  const sav=D.txs.filter(t=>t.type==='saving').reduce((s,t)=>s+t.amount,0);
  const inv=D.txs.filter(t=>t.type==='investment').reduce((s,t)=>s+t.amount,0);
  const mInc=D.txs.filter(t=>t.type==='income'&&inPeriod(t,'monthly')).reduce((s,t)=>s+t.amount,0);
  const mExp=D.txs.filter(t=>t.type==='expense'&&inPeriod(t,'monthly')).reduce((s,t)=>s+t.amount,0);
  const savBal=D.savings.reduce((s,a)=>s+a.balance,0)+sav;
  const invBal=D.investments.reduce((s,i)=>s+i.currentValue,0)+inv;
  const bycat={};D.txs.filter(t=>t.type==='expense').forEach(t=>{bycat[t.category]=(bycat[t.category]||0)+t.amount;});
  const topCats=Object.entries(bycat).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([c,v])=>`${c}: Rs.${v.toLocaleString()}`).join(', ');
  const goalsSummary=D.goals.map(g=>`${g.name}: ${((g.saved/g.target)*100).toFixed(0)}% complete (Rs.${g.saved.toLocaleString()} of Rs.${g.target.toLocaleString()}, monthly contribution: Rs.${(g.monthly||0).toLocaleString()})`).join('; ')||'none';
  const savSum=D.savings.map(s=>`${s.name} Rs.${s.balance.toLocaleString()} at ${s.rate}% p.a.`).join(', ')||'none';
  const invSum=D.investments.map(i=>`${i.name} (${i.type}): invested Rs.${i.cost.toLocaleString()}, now Rs.${i.currentValue.toLocaleString()} (${i.currentValue>=i.cost?'+':'-'}${Math.abs(((i.currentValue-i.cost)/i.cost)*100).toFixed(1)}%)`).join(', ')||'none';
  const nw=inc-exp+savBal+invBal;
  const sr=mInc>0?(((mInc-mExp)/mInc)*100).toFixed(1):0;
  return `You are Vault AI, an expert personal finance advisor built into the Vault LK app, specifically designed for Sri Lanka. You have real-time access to the user's complete financial data.

USER PROFILE:
- Name: ${D.user.name||'Unknown'}
- District: ${D.user.city||'Sri Lanka'}
- Occupation: ${D.user.job||'Unknown'}
- Approx monthly income: Rs.${D.user.income.toLocaleString()}
- Primary financial goal: ${D.user.goal||'General savings'}

LIVE FINANCIAL DATA:
- Net worth estimate: Rs.${nw.toLocaleString()}
- Total income logged: Rs.${inc.toLocaleString()}
- Total expenses logged: Rs.${exp.toLocaleString()}
- Total savings balance: Rs.${savBal.toLocaleString()}
- Total investment value: Rs.${invBal.toLocaleString()}
- This month income: Rs.${mInc.toLocaleString()}
- This month expenses: Rs.${mExp.toLocaleString()}
- This month savings rate: ${sr}%
- Monthly budget limit: Rs.${D.budgets.monthly.toLocaleString()||'not set'}
- Daily budget limit: Rs.${D.budgets.daily.toLocaleString()||'not set'}
- Top spending categories: ${topCats||'none yet'}
- Active goals: ${goalsSummary}
- Savings accounts: ${savSum}
- Investments: ${invSum}

SRI LANKA FINANCIAL CONTEXT (2024-2025):
- FD rates: NSB/BOC 12-13.5%, private banks 11-13%
- CBSL policy rates: SDFR ~8.25%, SLFR ~9.25%
- Income tax free threshold: Rs.1.8M/year (Rs.150K/month)
- EPF: employee 8% + employer 12% = 20% total
- USD rate: approx Rs.290-315
- Inflation: returning to 4-6% after 2022 crisis
- CSE: recovering market, JKH/DIAL/COMB are blue chips
- VAT: 18% standard rate

INSTRUCTIONS:
- Give detailed, comprehensive responses with specific Sri Lanka data, rates, and examples
- Always reference the user's actual financial numbers in your advice
- Provide step-by-step actionable advice, not just generic tips
- Compare options with real numbers (e.g., "If you put Rs.50,000 in NSB FD at 13%...")
- Flag if savings rate is below 20% or if budget is exceeded
- Suggest specific products by name (NSB, BOC, Sampath FDs; CT Smith for stocks; etc.)
- Be conversational but thorough â€” responses can be 200-400 words when the topic deserves it
- Use emojis to organize sections but keep them purposeful
- Always end with one concrete next action the user can take today`;
}

async function sendChat(){
  const inp=document.getElementById('chatInput');
  const msg=inp.value.trim();
  if(!msg)return;
  inp.value='';
  addChatMsg('user',msg);
  chatHistory.push({role:'user',content:msg});
  showTyping();
  try{
    const res=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'x-api-key':'',
        'anthropic-version':'2023-06-01',
        'anthropic-dangerous-direct-browser-access':'true'
      },
      body:JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:600,
        system:buildContext(),
        messages:chatHistory.slice(-12),
      })
    });
    if(!res.ok){throw new Error('API '+res.status);}
    const data=await res.json();
    hideTyping();
    const reply=data.content?.[0]?.text||'Sorry, I had trouble responding. Please try again.';
    addChatMsg('ai',reply);
    chatHistory.push({role:'assistant',content:reply});
  }catch(e){
    hideTyping();
    // Always fall through to rich offline AI â€” never show error to user
    addChatMsg('ai', getLocalAIResponse(msg));
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   AUTO EMAIL SCHEDULER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildDailySummaryBody(){
  const mInc=D.txs.filter(t=>t.type==='income'&&inPeriod(t,'monthly')).reduce((s,t)=>s+t.amount,0);
  const mExp=D.txs.filter(t=>t.type==='expense'&&inPeriod(t,'monthly')).reduce((s,t)=>s+t.amount,0);
  const dExp=D.txs.filter(t=>t.type==='expense'&&inPeriod(t,'daily')).reduce((s,t)=>s+t.amount,0);
  const sr=mInc>0?(((mInc-mExp)/mInc)*100).toFixed(1):0;
  const bycat={};D.txs.filter(t=>t.type==='expense'&&inPeriod(t,'monthly')).forEach(t=>{bycat[t.category]=(bycat[t.category]||0)+t.amount;});
  const topCats=Object.entries(bycat).sort((a,b)=>b[1]-a[1]).slice(0,3).map(([c,v])=>`  â€¢ ${c.replace(/^.\s/,'')}: Rs.${v.toLocaleString()}`).join('\n');
  const budLine=D.budgets.monthly>0?`Monthly budget: Rs.${D.budgets.monthly.toLocaleString()} | Used: ${((mExp/D.budgets.monthly)*100).toFixed(0)}% | Remaining: Rs.${Math.max(0,D.budgets.monthly-mExp).toLocaleString()}`:'Monthly budget: Not set';
  const goalsLine=D.goals.length?D.goals.map(g=>`  â€¢ ${g.name}: ${((g.saved/g.target)*100).toFixed(0)}% complete`).join('\n'):'  No goals set yet.';
  return `Good morning ${D.user.name||'there'}! â˜€ï¸\n\nHere is your Vault LK Daily Financial Summary â€” ${new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}.\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ“Š THIS MONTH SO FAR\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nIncome:       Rs.${mInc.toLocaleString()}\nExpenses:     Rs.${mExp.toLocaleString()}\nNet:          Rs.${(mInc-mExp).toLocaleString()}\nSavings rate: ${sr}%\n\n${budLine}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ“… TODAY\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nSpent today: Rs.${dExp.toLocaleString()}\n${D.budgets.daily>0?`Daily limit: Rs.${D.budgets.daily.toLocaleString()} | ${dExp>D.budgets.daily?'âš ï¸ OVER BUDGET':'âœ… Within budget'}`:'Daily budget: Not set'}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ›’ TOP EXPENSES THIS MONTH\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n${topCats||'  No expenses logged yet.'}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ¯ GOALS PROGRESS\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n${goalsLine}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’¡ TIP OF THE DAY\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n${getDailyTip()}\n\nKeep tracking â€” Vault LK ğŸ‡±ğŸ‡°\nVault LK Â· Smart Finance Â· Sri Lanka`;
}

function buildWeeklySummaryBody(){
  const wInc=D.txs.filter(t=>t.type==='income'&&inPeriod(t,'weekly')).reduce((s,t)=>s+t.amount,0);
  const wExp=D.txs.filter(t=>t.type==='expense'&&inPeriod(t,'weekly')).reduce((s,t)=>s+t.amount,0);
  const wSav=D.txs.filter(t=>t.type==='saving'&&inPeriod(t,'weekly')).reduce((s,t)=>s+t.amount,0);
  const wInv=D.txs.filter(t=>t.type==='investment'&&inPeriod(t,'weekly')).reduce((s,t)=>s+t.amount,0);
  const txCount=D.txs.filter(t=>inPeriod(t,'weekly')).length;
  const bycat={};D.txs.filter(t=>t.type==='expense'&&inPeriod(t,'weekly')).forEach(t=>{bycat[t.category]=(bycat[t.category]||0)+t.amount;});
  const topCats=Object.entries(bycat).sort((a,b)=>b[1]-a[1]).slice(0,4).map(([c,v])=>`  â€¢ ${c.replace(/^.\s/,'')}: Rs.${v.toLocaleString()}`).join('\n');
  const savBal=D.savings.reduce((s,a)=>s+a.balance,0);
  return `Hello ${D.user.name||'there'} ğŸ‘‹\n\nHere is your Vault LK WEEKLY REPORT.\nWeek of ${new Date().toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'})}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ“Š THIS WEEK AT A GLANCE\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nIncome:      Rs.${wInc.toLocaleString()}\nExpenses:    Rs.${wExp.toLocaleString()}\nSaved:       Rs.${wSav.toLocaleString()}\nInvested:    Rs.${wInv.toLocaleString()}\nTransactions logged: ${txCount}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ›’ WEEKLY SPENDING BREAKDOWN\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n${topCats||'  No expenses logged this week.'}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ¦ SAVINGS ACCOUNTS\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n${D.savings.length?D.savings.map(a=>`  â€¢ ${a.name}: Rs.${a.balance.toLocaleString()} @ ${a.rate}%`).join('\n'):'  No savings accounts added yet.'}\nTotal savings balance: Rs.${savBal.toLocaleString()}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ¯ GOALS PROGRESS\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n${D.goals.length?D.goals.map(g=>`  â€¢ ${g.name}: ${((g.saved/g.target)*100).toFixed(0)}% (Rs.${g.saved.toLocaleString()} / Rs.${g.target.toLocaleString()})`).join('\n'):'  No goals set.'}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’¡ WEEK AHEAD TIP\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n${getDailyTip()}\n\nHave a productive week!\nVault LK Â· Smart Finance Â· Sri Lanka ğŸ‡±ğŸ‡°`;
}

function buildMonthlySummaryBody(){
  const mInc=D.txs.filter(t=>t.type==='income'&&inPeriod(t,'monthly')).reduce((s,t)=>s+t.amount,0);
  const mExp=D.txs.filter(t=>t.type==='expense'&&inPeriod(t,'monthly')).reduce((s,t)=>s+t.amount,0);
  const mSav=D.txs.filter(t=>t.type==='saving'&&inPeriod(t,'monthly')).reduce((s,t)=>s+t.amount,0);
  const mInv=D.txs.filter(t=>t.type==='investment'&&inPeriod(t,'monthly')).reduce((s,t)=>s+t.amount,0);
  const sr=mInc>0?(((mInc-mExp)/mInc)*100).toFixed(1):0;
  const savBal=D.savings.reduce((s,a)=>s+a.balance,0)+D.txs.filter(t=>t.type==='saving').reduce((s,t)=>s+t.amount,0);
  const invBal=D.investments.reduce((s,i)=>s+i.currentValue,0)+D.txs.filter(t=>t.type==='investment').reduce((s,t)=>s+t.amount,0);
  const bycat={};D.txs.filter(t=>t.type==='expense'&&inPeriod(t,'monthly')).forEach(t=>{bycat[t.category]=(bycat[t.category]||0)+t.amount;});
  const topCats=Object.entries(bycat).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([c,v])=>`  â€¢ ${c.replace(/^.\s/,'')}: Rs.${v.toLocaleString()} (${mExp>0?((v/mExp)*100).toFixed(0):0}%)`).join('\n');
  const mn=new Date();mn.setMonth(mn.getMonth()-1);
  const monthName=mn.toLocaleDateString('en-US',{month:'long',year:'numeric'});
  return `Hello ${D.user.name||'there'} ğŸ“Š\n\nYour VAULT LK MONTHLY REPORT is ready!\n${monthName}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’° MONTHLY FINANCIAL SUMMARY\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nTotal Income:     Rs.${mInc.toLocaleString()}\nTotal Expenses:   Rs.${mExp.toLocaleString()}\nNet (saved/inv):  Rs.${(mInc-mExp).toLocaleString()}\nAmount Saved:     Rs.${mSav.toLocaleString()}\nAmount Invested:  Rs.${mInv.toLocaleString()}\nSavings Rate:     ${sr}%\n\n${D.budgets.monthly>0?`Budget: Rs.${D.budgets.monthly.toLocaleString()} | ${mExp<=D.budgets.monthly?`âœ… Stayed within budget! Saved Rs.${(D.budgets.monthly-mExp).toLocaleString()}`:`âš ï¸ Over budget by Rs.${(mExp-D.budgets.monthly).toLocaleString()}`}`:''}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ›’ SPENDING BY CATEGORY\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n${topCats||'  No expense data.'}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ¦ WEALTH SNAPSHOT\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nSavings Balance: Rs.${savBal.toLocaleString()}\nInvestments:     Rs.${invBal.toLocaleString()}\nEst. Net Worth:  Rs.${(mInc-mExp+savBal+invBal).toLocaleString()}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ¯ GOALS STATUS\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n${D.goals.length?D.goals.map(g=>`  â€¢ ${g.name}: ${((g.saved/g.target)*100).toFixed(0)}% complete\n    Rs.${g.saved.toLocaleString()} of Rs.${g.target.toLocaleString()}`).join('\n'):'  No goals set â€” add goals in the app!'}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’¡ NEXT MONTH FOCUS\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n${Number(sr)<10?'âš ï¸ Savings rate needs improvement. Target 20% minimum next month.':Number(sr)<20?'ğŸ‘ Good progress! Push towards 20% savings rate next month.':'ğŸ† Excellent savings rate! Consider increasing your investments.'}\n\nGreat work tracking your finances!\nVault LK Â· Smart Finance Â· Sri Lanka ğŸ‡±ğŸ‡°`;
}

function getDailyTip(){
  const tips=[
    'NSB Fixed Deposits currently offer up to 13.5% annual interest â€” one of the safest high-yield options in Sri Lanka.',
    'The 50/30/20 rule: 50% needs, 30% wants, 20% savings. Even Rs.5,000 saved monthly = Rs.60,000/year.',
    'Open a CDS account with a CSE broker to start investing in Sri Lanka blue chips like JKH and Dialog.',
    'Emergency fund target: 3 months of expenses. If you spend Rs.60,000/month, save Rs.180,000 before investing.',
    'EPF earns ~9-11% interest â€” ensure your employer deposits correctly every month. Check at epf.cbsl.gov.lk.',
    'Vehicle running cost in Sri Lanka averages Rs.30,000-50,000/month including fuel, insurance and maintenance.',
    'Income tax free up to Rs.150,000/month (Rs.1.8M/year). Above that, tax starts at 6%.',
    'Rs.10,000 invested monthly at 12% annual return = Rs.2.3M in 10 years. Start small, start now.',
    'Compare FD rates across banks before locking in â€” difference of 1-2% on Rs.500K = Rs.5,000-10,000/year.',
    'Term life insurance is cheapest: Rs.10M cover for ~Rs.2,000/month at age 30. Don\'t mix insurance with investment.',
    'The CSE All Share Index is recovering post-2022. Long-term investors who stayed patient have been rewarded.',
    'Freelancing on Upwork/Fiverr in USD and converting at Rs.300+ rate is one of the best income boosts available.',
    'Avoid HP (hire purchase) for electronics â€” effective interest rate can be 30-40% annually.',
    'Set up a standing order to auto-transfer savings on payday. What you don\'t see, you don\'t spend.',
    'BOC and People\'s Bank are government-backed â€” safest for large deposits over Rs.1M.'
  ];
  return tips[new Date().getDate()%tips.length];
}

function sendDailySummaryEmail(manual=false){
  if(!D.user.email){if(manual){toastM('âš ï¸ Set your email first');openEmailModal();}return;}
  const today=new Date().toDateString();
  const flagKey='vlt_daily_email_'+today;
  if(!manual&&localStorage.getItem(flagKey))return; // already sent today
  localStorage.setItem(flagKey,'1');
  const sub=encodeURIComponent(`ğŸ“Š Vault LK Daily Summary â€” ${new Date().toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'})}`);
  const body=encodeURIComponent(buildDailySummaryBody());
  window.open(`mailto:${D.user.email}?subject=${sub}&body=${body}`);
  toastM('ğŸ“§ Daily summary ready to send!');
}

function sendWeeklyEmail(manual=false){
  if(!D.user.email)return;
  const weekKey='vlt_weekly_email_'+getWeekKey();
  if(!manual&&localStorage.getItem(weekKey))return;
  localStorage.setItem(weekKey,'1');
  const sub=encodeURIComponent(`ğŸ“ˆ Vault LK Weekly Report â€” Week of ${new Date().toLocaleDateString('en-US',{month:'short',day:'numeric'})}`);
  const body=encodeURIComponent(buildWeeklySummaryBody());
  window.open(`mailto:${D.user.email}?subject=${sub}&body=${body}`);
  toastM('ğŸ“§ Weekly report ready to send!');
}

function sendMonthlyEmail(manual=false){
  if(!D.user.email)return;
  const monthKey='vlt_monthly_email_'+new Date().getFullYear()+'_'+new Date().getMonth();
  if(!manual&&localStorage.getItem(monthKey))return;
  localStorage.setItem(monthKey,'1');
  const sub=encodeURIComponent(`ğŸ“Š Vault LK Monthly Report â€” ${new Date().toLocaleDateString('en-US',{month:'long',year:'numeric'})}`);
  const body=encodeURIComponent(buildMonthlySummaryBody());
  window.open(`mailto:${D.user.email}?subject=${sub}&body=${body}`);
  toastM('ğŸ“§ Monthly report ready to send!');
}

function getWeekKey(){
  const d=new Date();
  const startOfYear=new Date(d.getFullYear(),0,1);
  return d.getFullYear()+'_w'+Math.ceil(((d-startOfYear)/86400000+startOfYear.getDay()+1)/7);
}

// Email schedule toggle states
function toggleSchedule(type){
  if(!D.user.emailSchedule) D.user.emailSchedule={daily:false,weekly:false,monthly:false};
  D.user.emailSchedule[type]=!D.user.emailSchedule[type];
  if(D.user.emailSchedule[type]&&!D.user.email){
    D.user.emailSchedule[type]=false;
    toastM('âš ï¸ Set your email first');
    openEmailModal();
    return;
  }
  sv();
  updateScheduleToggleUI();
  toastM(D.user.emailSchedule[type]?`ğŸ”” ${type.charAt(0).toUpperCase()+type.slice(1)} emails ON`:`ğŸ”• ${type.charAt(0).toUpperCase()+type.slice(1)} emails OFF`);
}

function updateScheduleToggleUI(){
  const sch=D.user.emailSchedule||{daily:false,weekly:false,monthly:false};
  ['daily','weekly','monthly'].forEach(t=>{
    const tog=document.getElementById(t+'EmailToggle');
    const thumb=document.getElementById(t+'EmailThumb');
    if(!tog||!thumb)return;
    tog.style.background=sch[t]?'var(--gr)':'var(--ln2)';
    thumb.style.left=sch[t]?'21px':'3px';
  });
}

// â”€â”€ Auto scheduler: runs every 60 seconds when app is open â”€â”€
function runEmailScheduler(){
  if(!D.user.email||!D.user.emailSchedule)return;
  const now=new Date();
  const h=now.getHours();
  const sch=D.user.emailSchedule;
  // Daily: 8am
  if(sch.daily&&h>=8&&h<9) sendDailySummaryEmail(false);
  // Weekly: Monday 9am
  if(sch.weekly&&now.getDay()===1&&h>=9&&h<10) sendWeeklyEmail(false);
  // Monthly: 1st of month 9am
  if(sch.monthly&&now.getDate()===1&&h>=9&&h<10) sendMonthlyEmail(false);
}
setInterval(runEmailScheduler, 60000);

// â•â• EMAIL â•â•
function openEmailModal(){
  document.getElementById('emailInput').value=D.user.email||'';
  openMod('emailModal');
}
function saveEmail(){
  const email=document.getElementById('emailInput').value.trim();
  D.user.email=email; sv(); closeMod('emailModal');
  renderProfile();
  toastM(email?'ğŸ“§ Email saved!':'Email cleared');
}
function toggleEmailNotify(){
  D.user.emailNotify=!D.user.emailNotify; sv();
  updateEmailToggleUI();
  toastM(D.user.emailNotify?'ğŸ”” Budget alerts ON':'ğŸ”• Budget alerts OFF');
}
function updateEmailToggleUI(){
  const tog=document.getElementById('emailToggle');
  const thumb=document.getElementById('emailToggleThumb');
  if(!tog||!thumb)return;
  tog.style.background=D.user.emailNotify?'var(--gr)':'var(--ln2)';
  thumb.style.left=D.user.emailNotify?'21px':'3px';
}
function sendTestEmail(){
  if(!D.user.email){toastM('âš ï¸ Please set your email first');openEmailModal();return;}
  const sub=encodeURIComponent('ğŸ“§ Vault LK â€” Test Notification');
  const body=encodeURIComponent(`Hi ${D.user.name||'there'},\n\nVault LK email notifications are working correctly! âœ…\n\nYour current snapshot:\nâ€¢ This month income: Rs.${D.txs.filter(t=>t.type==='income'&&inPeriod(t,'monthly')).reduce((s,t)=>s+t.amount,0).toLocaleString()}\nâ€¢ This month expenses: Rs.${D.txs.filter(t=>t.type==='expense'&&inPeriod(t,'monthly')).reduce((s,t)=>s+t.amount,0).toLocaleString()}\nâ€¢ Monthly budget: ${D.budgets.monthly>0?'Rs.'+D.budgets.monthly.toLocaleString():'Not set'}\nâ€¢ Goals active: ${D.goals.length}\n\n${getDailyTip()}\n\nVault LK Â· Smart Finance Â· Sri Lanka ğŸ‡±ğŸ‡°`);
  window.open(`mailto:${D.user.email}?subject=${sub}&body=${body}`);
  toastM('ğŸ“§ Opening mail app...');
}
function triggerBudgetAlert(type,spent,limit){
  if(!D.user.emailNotify||!D.user.email)return;
  const pct=((spent/limit)*100).toFixed(0);
  const sub=encodeURIComponent(`âš ï¸ Vault LK â€” ${type} Budget Alert`);
  const body=encodeURIComponent(`Hi ${D.user.name||'there'},\n\nâš ï¸ BUDGET ALERT\n\nYour ${type} budget is ${pct}% used.\n\nSpent:  Rs.${spent.toLocaleString()}\nLimit:  Rs.${limit.toLocaleString()}\n${spent>limit?`Over by: Rs.${(spent-limit).toLocaleString()}\n`:''}\nğŸ’¡ Tip: Review your top spending categories in Vault LK and find areas to trim.\n\n${getDailyTip()}\n\nVault LK Â· Smart Finance Â· Sri Lanka ğŸ‡±ğŸ‡°`);
  window.open(`mailto:${D.user.email}?subject=${sub}&body=${body}`);
}

// â•â• TOAST â•â•
function toastM(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('on');clearTimeout(t._t);t._t=setTimeout(()=>t.classList.remove('on'),2500);}

// â•â• KEYBOARD â•â•
document.getElementById('fAmt').addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('fDesc').focus();});
document.getElementById('fDesc').addEventListener('keydown',e=>{if(e.key==='Enter')addTx();});

// â•â• PWA SETUP â•â•
(function initPWA(){
  // â”€â”€ Generate icon as canvas data URL â”€â”€
  function makeIcon(size){
    const c=document.createElement('canvas');
    c.width=c.height=size;
    const ctx=c.getContext('2d');
    // Background
    ctx.fillStyle='#06080f';
    ctx.beginPath();
    ctx.roundRect(0,0,size,size,size*0.2);
    ctx.fill();
    // Gold gradient circle
    const grd=ctx.createRadialGradient(size*.5,size*.4,size*.05,size*.5,size*.4,size*.45);
    grd.addColorStop(0,'#f0c040');
    grd.addColorStop(1,'#d4a200');
    ctx.fillStyle=grd;
    ctx.beginPath();
    ctx.arc(size*.5,size*.42,size*.3,0,Math.PI*2);
    ctx.fill();
    // "V" letter
    ctx.fillStyle='#06080f';
    ctx.font=`bold ${size*.38}px Arial`;
    ctx.textAlign='center';
    ctx.textBaseline='middle';
    ctx.fillText('V',size*.5,size*.44);
    // Bottom text
    ctx.fillStyle='#8fa3c8';
    ctx.font=`bold ${size*.1}px Arial`;
    ctx.fillText('VAULT LK',size*.5,size*.8);
    return c.toDataURL('image/png');
  }

  const icon192=makeIcon(192);
  const icon512=makeIcon(512);
  const icon180=makeIcon(180);

  // â”€â”€ Apple touch icon â”€â”€
  document.getElementById('apple-icon').href=icon180;

  // â”€â”€ Build manifest as blob URL â”€â”€
  const manifest={
    name:'Vault LK',
    short_name:'Vault LK',
    description:'Smart personal finance tracker for Sri Lanka',
    start_url:'.',
    display:'standalone',
    background_color:'#06080f',
    theme_color:'#06080f',
    orientation:'portrait-primary',
    lang:'en',
    icons:[
      {src:icon192,sizes:'192x192',type:'image/png',purpose:'any maskable'},
      {src:icon512,sizes:'512x512',type:'image/png',purpose:'any maskable'}
    ]
  };
  const mBlob=new Blob([JSON.stringify(manifest)],{type:'application/manifest+json'});
  document.getElementById('pwa-manifest').href=URL.createObjectURL(mBlob);

  // â”€â”€ Register Service Worker via blob â”€â”€
  const swCode=`
const CACHE='vault-lk-v1';
const ASSETS=['/'];
self.addEventListener('install',e=>{
  e.waitUntil(caches.open(CACHE).then(c=>c.addAll([])).then(()=>self.skipWaiting()));
});
self.addEventListener('activate',e=>{
  e.waitUntil(clients.claim());
});
self.addEventListener('fetch',e=>{
  e.respondWith(
    caches.match(e.request).then(r=>r||fetch(e.request).catch(()=>new Response('Offline',{status:503})))
  );
});
`;
  if('serviceWorker' in navigator){
    const swBlob=new Blob([swCode],{type:'application/javascript'});
    const swURL=URL.createObjectURL(swBlob);
    navigator.serviceWorker.register(swURL,{scope:'/'})
      .then(()=>console.log('Vault LK SW registered'))
      .catch(e=>console.warn('SW reg failed (expected on file://):',e));
  }

  // â”€â”€ Install prompt â”€â”€
  let deferredPrompt=null;
  window.addEventListener('beforeinstallprompt',e=>{
    e.preventDefault();
    deferredPrompt=e;
    // Show install banner after 3 seconds if not installed
    setTimeout(()=>{
      if(deferredPrompt) showInstallBanner();
    },3000);
  });

  function showInstallBanner(){
    if(document.getElementById('pwa-banner'))return;
    const banner=document.createElement('div');
    banner.id='pwa-banner';
    banner.style.cssText='position:fixed;bottom:80px;left:16px;right:16px;background:#1a2235;border:1px solid #f0c040;border-radius:14px;padding:14px 16px;display:flex;align-items:center;gap:12px;z-index:9999;box-shadow:0 8px 32px rgba(0,0,0,.5);animation:slideUp .3s ease';
    banner.innerHTML=`
      <span style="font-size:28px">ğŸ’°</span>
      <div style="flex:1">
        <div style="font-family:'Clash Display',sans-serif;font-weight:700;color:#f0c040;font-size:15px">Install Vault LK</div>
        <div style="font-size:12px;color:#8fa3c8;margin-top:2px">Add to home screen for best experience</div>
      </div>
      <button onclick="window._vaultInstall()" style="background:linear-gradient(135deg,#f0c040,#d4a200);color:#000;border:none;border-radius:8px;padding:8px 14px;font-weight:700;cursor:pointer;font-size:13px">Install</button>
      <button onclick="this.parentElement.remove()" style="background:none;border:none;color:#3d5070;font-size:20px;cursor:pointer;line-height:1">âœ•</button>
    `;
    document.body.appendChild(banner);
  }

  window._vaultInstall=function(){
    if(!deferredPrompt)return;
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(()=>{
      deferredPrompt=null;
      const b=document.getElementById('pwa-banner');
      if(b)b.remove();
    });
  };
})();

// â•â• CHECK FIRST LAUNCH â•â•
if(D.user.name){
  document.getElementById('onboarding').style.display='none';
  document.getElementById('app').classList.remove('hidden');
  go('home');
  setTimeout(()=>{
    addChatMsg('ai',`Welcome back, ${D.user.name}! ğŸ‘‹ I'm Vault AI. Ask me anything about your finances.`);
  },1000);
}
</script>
</body>
</html>
